const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/SplashView-CD4pcPVj.js","assets/vendor-react-DZ0IVLBb.js","assets/vendor-CCVjAPEY.js","assets/vendor-maps-S3fC-LOA.js","assets/vendor-maps-CIGW-MKW.css","assets/Button-BzswROfv.js","assets/translations-CdcWkPcN.js","assets/vendor-jspdf-Bd23t5aa.js","assets/vendor-supabase-ChvUvA8t.js","assets/DashboardView-CP0_Iq03.js","assets/Card-Ct5MaHk4.js","assets/inventoryStatus-BGlXoNrp.js","assets/Input-D28zJcRZ.js","assets/vendor-charts-CIj2E38x.js","assets/HelpFormView-hA3g0qS4.js","assets/SettingsView-D4ma2ld0.js","assets/HouseholdManager-CdnXGOHB.js","assets/MapView-DR9-Po9M.js","assets/mockGenAI-BPqgTz-A.js","assets/GapView-ZtteFLg4.js","assets/AssessmentView-CLV32Eh3.js","assets/PopulationView-P9MCzStU.js","assets/RecoveryView-D5TpOlyF.js","assets/DroneView-D58Oc25c.js","assets/LogisticsView--HDBzsdF.js","assets/RegistrationView-BJ4EY3tS.js","assets/OrgDashboardView-f_hsxNGJ.js","assets/LoginView-BU7xdRLv.js","assets/PresentationView-B5kgLT0w.js","assets/PrivacyPolicyView-DcRj1VLD.js","assets/ResetPasswordView-BWZH2UHC.js","assets/BuildKitView-Ce-CY2mS.js","assets/ReadinessView-7Oj4Z9Yo.js","assets/ReadinessGapView-T5yOFGmk.js"])))=>i.map(i=>d[i]);
import{j as l,H as Ie,C as be,S as ve,a as g,c as de,d as Ne}from"./vendor-react-DZ0IVLBb.js";import{_ as b}from"./vendor-jspdf-Bd23t5aa.js";import{c as Se}from"./vendor-supabase-ChvUvA8t.js";import"./vendor-maps-S3fC-LOA.js";import"./vendor-CCVjAPEY.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function r(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(s){if(s.ep)return;s.ep=!0;const i=r(s);fetch(s.href,i)}})();const Re=({currentView:e,setView:t})=>{const r=[{id:"DASHBOARD",icon:l.jsx(Ie,{size:24}),label:"Home"},{id:"HELP_WIZARD",icon:l.jsx(be,{size:24}),label:"Get Help"},{id:"SETTINGS",icon:l.jsx(ve,{size:24}),label:"Settings"}];return l.jsx("nav",{className:"fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 pb-safe pt-2 px-6 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-50 print:hidden",children:l.jsx("div",{className:"flex justify-between items-center max-w-md mx-auto pb-4",children:r.map(n=>{const s=e===n.id;return l.jsxs("button",{onClick:()=>t(n.id),className:`flex flex-col items-center gap-1 min-w-[64px] transition-colors ${s?"text-brand-600":"text-slate-400 hover:text-slate-600"}`,children:[l.jsx("div",{className:`p-1 rounded-full ${s?"bg-brand-50":""}`,children:n.icon}),l.jsx("span",{className:"text-[10px] font-medium",children:n.label})]},n.id)})})})},De={"Water Cases":"water","Food Boxes":"food",Blankets:"blankets","Medical Kits":"medicalKits"},Ae=/^(0[1-9]|1[0-2])\/(0[1-9]|[12]\d|3[01])\/(19\d{2}|20\d{2})$/,ce=e=>Ae.test((e||"").trim()),Ce=e=>{if(!ce(e))return null;const[t,r,n]=e.split("/").map(i=>Number(i)),s=new Date(n,t-1,r);return s.getFullYear()!==n||s.getMonth()!==t-1||s.getDate()!==r?null:s},W=e=>{const t=Ce(e);if(!t)return null;const r=new Date;let n=r.getFullYear()-t.getFullYear();const s=r.getMonth()-t.getMonth();return(s<0||s===0&&r.getDate()<t.getDate())&&(n-=1),n<0||n>130?null:n},Ut=e=>{const t=W(e);if(t!==null)return t<=2?"INFANT":t<=12?"CHILD":t<=17?"TEEN":t>=65?"SENIOR":"ADULT"},ue=e=>{var t,r;for(let n=0;n<(e||[]).length;n+=1){const s=e[n],i=((t=s==null?void 0:s.name)==null?void 0:t.trim())||`Member ${n+1}`;if(!((r=s==null?void 0:s.name)!=null&&r.trim()))return{ok:!1,error:`Household member ${n+1} name is required.`};const o=String(s.age||"").trim();if(!ce(o)||W(o)===null)return{ok:!1,error:`${i}: Date of birth must use MM/DD/YYYY.`};if(typeof s.mobilityFlag!="boolean")return{ok:!1,error:`${i}: Mobility flag is required.`};if(typeof s.medicalFlag!="boolean")return{ok:!1,error:`${i}: Medical flag is required.`}}return{ok:!0}},Oe="https://zghyxeieetqubodgplgo.supabase.co",le="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpnaHl4ZWllZXRxdWJvZGdwbGdvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1MDkwNzcsImV4cCI6MjA4NjA4NTA3N30.4ML7Ce1VsVQfhbmuChWk6_tRdx_doRWIzxC9nS873B8",B=!!le,me="Missing Supabase environment variables: VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY";B||console.warn(me);const c=Se(B?Oe:"https://example.supabase.co",B?le:"public-anon-key",{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0},realtime:{params:{eventsPerSecond:10}}});async function V(e){const t=e==null?void 0:e.trim().replace(/[–—−]/g,"-").replace(/\s+/g,"").toUpperCase();if(!t)return null;const{data:r,error:n}=await c.from("organizations").select("id, org_code, name").eq("org_code",t).single();return n||!r?null:{orgId:r.id,orgCode:r.org_code,orgName:r.name}}async function v(e){const t=await V(e);return(t==null?void 0:t.orgId)||null}const qe=e=>({water:Number((e==null?void 0:e.water)||0),food:Number((e==null?void 0:e.food)||0),blankets:Number((e==null?void 0:e.blankets)||0),medicalKits:Number((e==null?void 0:e.medical_kits)||0)}),L=e=>!e||e==="APPROVED"?"PENDING":e,Y=async e=>{const{data:t,error:r}=await c.from("organizations").select("org_code").eq("id",e).single();return r||!t?null:t.org_code},E=async e=>{var t;try{const{data:r}=await c.auth.getUser(),n=((t=r==null?void 0:r.user)==null?void 0:t.id)||null,s=e.orgCode?await v(e.orgCode):null;await c.from("activity_log").insert({org_id:s,user_id:n,action:e.action,entity_type:e.entityType||null,entity_id:e.entityId||null,details:e.details||{}})}catch(r){console.warn("Activity log write failed",r)}},G=async e=>{const{data:t,error:r}=await c.from("profiles").select("id, org_id, full_name, role, email, phone").eq("id",e).single();return r||!t?null:t},xe=async e=>(await fetch(e)).blob(),Te=e=>String(e).toLowerCase()==="true",Pe=(e,t)=>{const r=t[e.trigger_key],n=(e.operator||"equals").toLowerCase(),s=e.trigger_value;if(e.trigger_type==="profile_flag"){const i=!!r,o=Te(s);return n==="equals"?i===o:!1}if(e.trigger_type==="risk_score"){const i=Number(r||0),o=Number(s||0);return n==="gte"?i>=o:n==="lte"?i<=o:n==="equals"?i===o:!1}if(e.trigger_type==="alert_context"){const i=String(r||"").toLowerCase(),o=String(s||"").toLowerCase();return n==="contains"?i.includes(o):n==="equals"?i===o:!1}return!1},ke=e=>e>=8?10:e>=5?7:3,Ue=e=>e>=80?"HIGH":e>=40?"MEDIUM":"LOW";async function Me(){const{data:e,error:t}=await c.auth.getUser();if(t||!(e!=null&&e.user))throw new Error("Not authenticated");const r=e.user.id,[{data:n},{data:s},{data:i},{data:o}]=await Promise.all([c.from("vulnerability_profiles").select("organization_id, county_id, state_id, risk_score, medication_dependency, insulin_dependency, oxygen_powered_device, mobility_limitation, transportation_access, financial_strain").eq("profile_id",r).maybeSingle(),c.from("ready_kits").select("checked_ids, total_items, checked_items").eq("profile_id",r).maybeSingle(),c.from("kit_rules").select("trigger_type, trigger_key, operator, trigger_value, kit_item_id, kit_item, category, priority, outreach_flag, duration_bump_days, readiness_cap, explanation").eq("is_active",!0),c.from("profiles").select("org_id, county_id, state_id").eq("id",r).maybeSingle()]),d=(n==null?void 0:n.state_id)||(o==null?void 0:o.state_id)||null,a=(n==null?void 0:n.county_id)||(o==null?void 0:o.county_id)||null;let m=[];try{let p=c.from("alerts").select("event_type, expires_at").or(`expires_at.is.null,expires_at.gte.${new Date().toISOString()}`).order("created_at",{ascending:!1}).limit(100);d&&(p=p.eq("state_id",d)),a&&(p=p.eq("county_id",a));const{data:ye}=await p;m=(ye||[]).map(Ee=>String(Ee.event_type||"").toLowerCase()).filter(Boolean)}catch{m=[]}const u={risk_score:Number((n==null?void 0:n.risk_score)||0),medication_dependency:!!(n!=null&&n.medication_dependency),insulin_dependency:!!(n!=null&&n.insulin_dependency),oxygen_powered_device:!!(n!=null&&n.oxygen_powered_device),mobility_limitation:!!(n!=null&&n.mobility_limitation),transportation_access:!!((n==null?void 0:n.transportation_access)??!0),financial_strain:!!(n!=null&&n.financial_strain),active_alert_types:m.join("|")},h=(i||[]).filter(p=>Pe(p,u)),w=new Set((s==null?void 0:s.checked_ids)||[]),N=new Set,y=[],f=h.map(p=>({id:p.kit_item_id,item:p.kit_item,category:p.category,priority:p.priority,explanation:p.explanation}));let I=ke(Number(u.risk_score||0)),S=100;const P=new Set;for(const p of h)p.duration_bump_days&&Number(p.duration_bump_days)>0&&(I+=Number(p.duration_bump_days)),String(p.priority).toLowerCase()==="critical"&&(N.add(p.kit_item_id),w.has(p.kit_item_id)||(y.push({id:p.kit_item_id,item:p.kit_item,explanation:p.explanation}),S=Math.min(S,Number(p.readiness_cap||70)),p.outreach_flag&&P.add(p.outreach_flag)));const H=Math.max(1,Number((s==null?void 0:s.total_items)||0)),k=Math.max(0,Number((s==null?void 0:s.checked_items)||0)),j=Number((k/H*100).toFixed(2)),pe=Number(Math.min(j,S).toFixed(2)),we=u.risk_score>=8?"HIGH":u.risk_score>=5?"ELEVATED":"STANDARD",Q={profile_id:r,organization_id:(n==null?void 0:n.organization_id)||(o==null?void 0:o.org_id)||null,county_id:(n==null?void 0:n.county_id)||(o==null?void 0:o.county_id)||null,state_id:(n==null?void 0:n.state_id)||(o==null?void 0:o.state_id)||null,risk_score:Number(u.risk_score||0),recommended_duration_days:I,required_item_ids:Array.from(N),added_items:f,critical_missing_items:y,outreach_flags:Array.from(P),base_completion_pct:j,readiness_cap:S,readiness_score:pe,risk_tier:we,source_version:"kit-rules-v1",generated_at:new Date().toISOString(),updated_at:new Date().toISOString()},{error:J}=await c.from("kit_recommendations").upsert(Q,{onConflict:"profile_id"});if(J)throw J;return Q}async function Mt(e){const t=await v(e);if(!t)throw new Error("Organization not found");const{data:r,error:n}=await c.from("organization_outreach_flags_view").select("organization_id, state_id, county_id, outreach_flag, member_count, last_updated").eq("organization_id",t).order("member_count",{ascending:!1});if(n)throw n;return r||[]}async function Bt(e){const t=await v(e);if(!t)throw new Error("Organization not found");const{data:r,error:n}=await c.from("kit_recommendations").select("profile_id, readiness_score, readiness_cap, risk_tier, critical_missing_items, outreach_flags, updated_at").eq("organization_id",t).order("readiness_score",{ascending:!0}).limit(100);if(n)throw n;if(!r||r.length===0)return[];const s=Array.from(new Set(r.map(a=>a.profile_id).filter(Boolean)));if(s.length===0)return[];const{data:i,error:o}=await c.from("profiles").select("id, full_name, phone").in("id",s).eq("org_id",t);if(o)throw o;const d=new Map;for(const a of i||[])d.set(String(a.id),{full_name:a.full_name||null,phone:a.phone||null});return(r||[]).map(a=>{const m=d.get(String(a.profile_id)),u=Array.isArray(a.critical_missing_items)?a.critical_missing_items:[],_=Array.isArray(a.outreach_flags)?a.outreach_flags:[];return{profile_id:String(a.profile_id),member_name:(m==null?void 0:m.full_name)||"Unknown Member",phone:(m==null?void 0:m.phone)||null,readiness_score:Number(a.readiness_score||0),readiness_cap:Number(a.readiness_cap||100),risk_tier:String(a.risk_tier||"STANDARD"),critical_missing_items:u,critical_missing_count:u.length,outreach_flags:_,updated_at:a.updated_at||null}})}async function Lt(e){const t=e.communityId?await v(e.communityId):null,{error:r}=await c.from("profiles").upsert({id:e.id,email:e.email||null,phone:e.phone||null,full_name:e.fullName||null,role:e.role||"GENERAL_USER",org_id:t});if(r)throw r;return await E({action:"UPDATE",entityType:"profiles",entityId:e.id,orgCode:e.communityId||null}),{ok:!0}}async function Be(e){const{data:t,error:r}=await c.auth.getUser();if(r||!(t!=null&&t.user))throw new Error("Not authenticated");const n=e.communityId?await v(e.communityId):null,s={name:e.emergencyContactName||null,phone:e.emergencyContactPhone||null,relation:e.emergencyContactRelation||null},{error:i}=await c.from("profiles").update({full_name:e.fullName||null,phone:e.phone||null,mobile_phone:e.phone||null,email:e.email||null,role:e.role||void 0,org_id:n,home_address:e.address||null,emergency_contact:s}).eq("id",t.user.id);if(i)throw i;return await E({action:"UPDATE",entityType:"profiles",entityId:t.user.id,orgCode:e.communityId||null}),{ok:!0}}const Le=e=>String(e||"").trim().toUpperCase().replace(/[^A-Z0-9]/g,"").slice(0,6),K=e=>String(e||"").trim().toUpperCase().replace(/[^A-Z0-9-]/g,"").slice(0,24),z=e=>({id:e.id,householdId:e.household_id,inviterProfileId:e.inviter_profile_id,inviteeMemberRef:e.invitee_member_ref||void 0,inviteeName:e.invitee_name||void 0,invitationCode:e.invitation_code,status:String(e.status||"PENDING").toUpperCase(),acceptedByProfileId:e.accepted_by_profile_id||void 0,acceptedAt:e.accepted_at||void 0,expiresAt:e.expires_at||void 0,createdAt:e.created_at}),O=async e=>{const{data:t,error:r}=await c.from("household_memberships").select("household_id, role").eq("profile_id",e).maybeSingle();if(r)throw r;return t},F=async e=>{const{data:t,error:r}=await c.from("households").select("id, household_code, home_name").eq("id",e.household_id).single();if(r||!t)throw r||new Error("Household not found");const{count:n}=await c.from("household_memberships").select("profile_id",{count:"exact",head:!0}).eq("household_id",e.household_id);return{householdId:t.id,householdCode:t.household_code,householdName:t.home_name||"Your Home",householdRole:e.role,memberCount:Number(n||1)}};async function he(){const{data:e,error:t}=await c.auth.getUser();if(t||!(e!=null&&e.user))throw new Error("Not authenticated");const r=await O(e.user.id);return r?F(r):null}async function zt(){const{data:e,error:t}=await c.auth.getUser();if(t||!(e!=null&&e.user))throw new Error("Not authenticated");const r=await O(e.user.id);if(!(r!=null&&r.household_id))return[];const{data:n,error:s}=await c.from("household_invitations").select("id, household_id, inviter_profile_id, invitee_member_ref, invitee_name, invitation_code, status, accepted_by_profile_id, accepted_at, expires_at, created_at").eq("household_id",r.household_id).order("created_at",{ascending:!1}).limit(100);if(s)throw s;const i=n||[],o=Date.now(),d=i.filter(a=>a.status==="PENDING"&&a.expires_at&&Date.parse(a.expires_at)<=o).map(a=>a.id);return d.length>0&&await c.from("household_invitations").update({status:"EXPIRED"}).in("id",d),i.map(a=>d.includes(a.id)?z({...a,status:"EXPIRED"}):z(a))}async function Ft(e){const{data:t,error:r}=await c.auth.getUser();if(r||!(t!=null&&t.user))throw new Error("Not authenticated");const n=t.user.id,s=await O(n);if(!(s!=null&&s.household_id))throw new Error("Join or create a household first.");if(s.role!=="OWNER")throw new Error("Only household owners can create member invites.");const{data:i}=await c.from("household_invitations").select("id, household_id, inviter_profile_id, invitee_member_ref, invitee_name, invitation_code, status, accepted_by_profile_id, accepted_at, expires_at, created_at").eq("household_id",s.household_id).eq("invitee_member_ref",e.memberId).eq("status","PENDING").order("created_at",{ascending:!1}).limit(1).maybeSingle();if(i&&!e.forceNew){const y=i.expires_at?Date.parse(i.expires_at):0;if(!y||y>Date.now())return z(i)}i&&e.forceNew&&await c.from("household_invitations").update({status:"REVOKED"}).eq("id",i.id).eq("status","PENDING");const o=await F(s),d=K(e.suggestedCode||""),a=String(e.memberName||"").replace(/[^A-Z0-9]/gi,"").toUpperCase().slice(0,3).padEnd(3,"X"),m=y=>K(`${o.householdCode}-${y}`);let u=d||m(a);for(let y=0;y<5;y+=1){const{data:f}=await c.from("household_invitations").select("id").eq("invitation_code",u).maybeSingle();if(!f)break;const I=Math.random().toString(36).toUpperCase().replace(/[^A-Z0-9]/g,"").slice(2,5).padEnd(3,"X");u=m(I)}const _=Math.max(1,Number(e.expiresInDays||14)),h=new Date(Date.now()+_*24*60*60*1e3).toISOString(),{data:w,error:N}=await c.from("household_invitations").insert({household_id:s.household_id,inviter_profile_id:n,invitee_member_ref:e.memberId,invitee_name:e.memberName||null,invitation_code:u,status:"PENDING",expires_at:h}).select("id, household_id, inviter_profile_id, invitee_member_ref, invitee_name, invitation_code, status, accepted_by_profile_id, accepted_at, expires_at, created_at").single();if(N||!w)throw N||new Error("Unable to create invitation.");return await E({action:"CREATE",entityType:"household_invitations",entityId:w.id,details:{householdId:s.household_id,invitationCode:u}}),z(w)}async function Vt(e){const{data:t,error:r}=await c.auth.getUser();if(r||!(t!=null&&t.user))throw new Error("Not authenticated");const n=await O(t.user.id);if(!(n!=null&&n.household_id))throw new Error("Household not found.");if(n.role!=="OWNER")throw new Error("Only household owners can revoke invites.");const{data:s,error:i}=await c.from("household_invitations").select("id, household_id, status").eq("id",e).maybeSingle();if(i)throw i;if(!s||s.household_id!==n.household_id)throw new Error("Invitation not found.");if(s.status!=="PENDING")throw new Error("Only pending invitations can be revoked.");const{error:o}=await c.from("household_invitations").update({status:"REVOKED"}).eq("id",e).eq("status","PENDING");if(o)throw o;return await E({action:"UPDATE",entityType:"household_invitations",entityId:e,details:{status:"REVOKED"}}),{ok:!0}}async function fe(){const{data:e,error:t}=await c.auth.getUser();if(t||!(e!=null&&e.user))throw new Error("Not authenticated");const r=await he();if(r)return r;const n=e.user.id,{error:s}=await c.from("profiles").upsert({id:n,email:e.user.email||null},{onConflict:"id"});if(s)throw s;const{data:i,error:o}=await c.from("households").insert({owner_profile_id:n,home_name:"Your Home"}).select("id, household_code, home_name").single();if(o||!i)throw o||new Error("Unable to create household");const{error:d}=await c.from("household_memberships").insert({household_id:i.id,profile_id:n,role:"OWNER"});if(d)throw d;return await E({action:"CREATE",entityType:"households",entityId:i.id,details:{householdCode:i.household_code}}),{householdId:i.id,householdCode:i.household_code,householdName:i.home_name||"Your Home",householdRole:"OWNER",memberCount:1}}async function Gt(e){const t=Le(e),r=K(e),n=r.includes("-")||r.length>6;if((!t||t.length<6)&&!n)throw new Error("Enter a valid household or invite code.");const{data:s,error:i}=await c.auth.getUser();if(i||!(s!=null&&s.user))throw new Error("Not authenticated");const o=s.user.id;let d=null,a=null,m=null;if(n){const{data:h}=await c.from("household_invitations").select("id, household_id, invitation_code, status, expires_at").eq("invitation_code",r).maybeSingle();if(h){if(h.status!=="PENDING")throw new Error("This invitation is no longer active.");if(h.expires_at&&Date.parse(h.expires_at)<=Date.now())throw await c.from("household_invitations").update({status:"EXPIRED"}).eq("id",h.id),new Error("This invitation code has expired.");const{data:w}=await c.from("households").select("id, household_code, home_name").eq("id",h.household_id).maybeSingle();if(!w)throw new Error("Invitation household was not found.");d=w,a=h.id,m=h.invitation_code}}if(!d){const{data:h,error:w}=await c.from("households").select("id, household_code, home_name").eq("household_code",t).single();if(w||!h)throw new Error("Household code not found.");d=h}const u=await O(o);if((u==null?void 0:u.household_id)===d.id)return a&&await c.from("household_invitations").update({status:"ACCEPTED",accepted_by_profile_id:o,accepted_at:new Date().toISOString()}).eq("id",a).eq("status","PENDING"),F({household_id:d.id,role:u.role||"MEMBER"});if(u!=null&&u.household_id){const{error:h}=await c.from("household_memberships").delete().eq("profile_id",o);if(h)throw h}const{error:_}=await c.from("household_memberships").insert({household_id:d.id,profile_id:o,role:"MEMBER"});if(_)throw _;return a&&await c.from("household_invitations").update({status:"ACCEPTED",accepted_by_profile_id:o,accepted_at:new Date().toISOString()}).eq("id",a).eq("status","PENDING"),await E({action:"UPDATE",entityType:"household_memberships",entityId:d.id,details:{joinedBy:o,householdCode:d.household_code,invitationCode:m}}),F({household_id:d.id,role:"MEMBER"})}async function ze(e){const{data:t,error:r}=await c.auth.getUser();if(r||!(t!=null&&t.user))throw new Error("Not authenticated");const n=ue(e.household||[]);if(!n.ok)throw new Error(n.error);if(!e.consentPreparednessPlanning)throw new Error("Consent is required for Vital Intake data.");const{error:s}=await c.from("profiles").upsert({id:t.user.id,email:t.user.email||null},{onConflict:"id"});if(s)throw s;const{error:i}=await c.from("vitals").upsert({profile_id:t.user.id,medical_needs:e.medicalNeeds||null,household:e.household||[],pet_details:e.petDetails||null,household_size:Math.max(1,Number(e.householdMembers)||(e.household||[]).length||1),medication_dependency:!!e.medicationDependency,insulin_dependency:!!e.insulinDependency,oxygen_powered_device:!!e.oxygenPoweredDevice,mobility_limitation:!!e.mobilityLimitation,transportation_access:!!e.transportationAccess,financial_strain:!!e.financialStrain,zip_code:e.zipCode||null,consent_preparedness_planning:!0,consent_timestamp:new Date().toISOString()},{onConflict:"profile_id"});if(i)throw i;const o=await G(t.user.id),d=Math.max(1,Number(e.householdMembers)||(e.household||[]).length||1),{error:a}=await c.from("vulnerability_profiles").upsert({profile_id:t.user.id,organization_id:(o==null?void 0:o.org_id)||null,county_id:null,state_id:null,household_size:d,medication_dependency:!!e.medicationDependency,insulin_dependency:!!e.insulinDependency,oxygen_powered_device:!!e.oxygenPoweredDevice,mobility_limitation:!!e.mobilityLimitation,transportation_access:!!e.transportationAccess,financial_strain:!!e.financialStrain,zip_code:e.zipCode||null,consent_preparedness_planning:!0,consent_timestamp:new Date().toISOString(),intake_source:"settings_vital_intake",intake_version:"v2-state-ready",updated_by:t.user.id},{onConflict:"profile_id"});if(a)throw a;return await E({action:"UPDATE",entityType:"vitals",entityId:t.user.id}),{ok:!0}}async function Fe(e){const{data:t,error:r}=await c.auth.getUser();if(r||!(t!=null&&t.user))throw new Error("Not authenticated");const n=ue(e||[]);if(!n.ok)throw new Error(n.error);const s=t.user.id,{error:i}=await c.from("household_members").delete().eq("profile_id",s);if(i)throw i;const o=(e||[]).map(d=>({profile_id:s,name:d.name,relationship:null,age:W(String(d.age||"")),date_of_birth:String(d.age||"").trim()||null,age_group:d.ageGroup||null,mobility_flag:!!d.mobilityFlag,medical_flag:!!d.medicalFlag,login_enabled:!!d.loginEnabled,special_needs:d.needs||null}));if(o.length>0){const{error:d}=await c.from("household_members").insert(o);if(d)throw d}return await E({action:"UPDATE",entityType:"household_members",entityId:s,details:{count:o.length}}),{ok:!0}}async function Ve(e){const{data:t,error:r}=await c.auth.getUser();if(r||!(t!=null&&t.user))throw new Error("Not authenticated");const n=t.user.id,{error:s}=await c.from("pets").delete().eq("profile_id",n);if(s)throw s;const i=(e||"").trim(),d=(i?i.split(/[,;]+/).map(a=>a.trim()).filter(Boolean):[]).map(a=>({profile_id:n,name:a.slice(0,255),type:null,medical_needs:null}));if(d.length>0){const{error:a}=await c.from("pets").insert(d);if(a)throw a}return await E({action:"UPDATE",entityType:"pets",entityId:n,details:{count:d.length}}),{ok:!0}}async function Ht(e){const{data:t,error:r}=await c.auth.getUser();if(r||!(t!=null&&t.user))throw new Error("Not authenticated");const{error:n}=await c.from("ready_kits").upsert({profile_id:t.user.id,checked_ids:e.checkedIds||[],total_items:e.totalItems||0,checked_items:e.checkedItems||0,updated_at:new Date().toISOString()},{onConflict:"profile_id"});if(n)throw n;try{let s=await O(t.user.id);if(s||(await fe(),s=await O(t.user.id)),s!=null&&s.household_id){const i=Math.max(0,Number(e.totalItems)||0),o=Math.max(0,Number(e.checkedItems)||0),d=i>0?Math.round(o/i*1e4)/100:0,a=new Date().toISOString();await c.from("household_readiness_scores").upsert({household_id:s.household_id,readiness_score:d,readiness_tier:Ue(d),total_items:i,checked_items:o,recommended_duration_days:Math.max(3,Math.ceil(i/10)||3),last_assessed_at:a,updated_at:a},{onConflict:"household_id"}),await c.from("readiness_items").update({is_completed:!1,updated_at:a}).eq("household_id",s.household_id).eq("source","ready_kit");const m=(e.checkedIds||[]).map(u=>String(u||"").trim()).filter(Boolean).map(u=>({household_id:s.household_id,item_id:u,item_name:u.replace(/[-_]/g," ").replace(/\b\w/g,_=>_.toUpperCase()),category:null,quantity_target:null,is_completed:!0,source:"ready_kit",updated_at:a}));m.length>0&&await c.from("readiness_items").upsert(m,{onConflict:"household_id,item_id"})}}catch(s){console.warn("Readiness domain sync skipped",s)}await E({action:"UPDATE",entityType:"ready_kits",entityId:t.user.id,details:{checkedItems:e.checkedItems,totalItems:e.totalItems}});try{await Me()}catch(s){console.warn("Kit guidance recompute failed",s)}return{ok:!0}}async function jt(){const{data:e,error:t}=await c.auth.getUser();if(t||!(e!=null&&e.user))throw new Error("Not authenticated");const{data:r,error:n}=await c.from("ready_kits").select("checked_ids, total_items, checked_items, updated_at").eq("profile_id",e.user.id).single();return n?null:r}async function Ge(e){const{data:t,error:r}=await c.auth.getUser();if(r||!(t!=null&&t.user))throw new Error("Not authenticated");if(!e.communityId)return{ok:!0};const n=await v(e.communityId);if(!n)throw new Error("Organization not found");const s=t.user.id,{error:i}=await c.from("members").upsert({id:s,org_id:n,name:e.fullName,status:"UNKNOWN",needs:[],phone:e.phone||null,address:e.address||null,emergency_contact_name:e.emergencyContactName||null,emergency_contact_phone:e.emergencyContactPhone||null,emergency_contact_relation:e.emergencyContactRelation||null},{onConflict:"id"});if(i)throw i;return await E({action:"UPDATE",entityType:"members",entityId:s,orgCode:e.communityId}),{ok:!0}}async function He(){var i,o,d;const{data:e,error:t}=await c.auth.getUser();if(t||!(e!=null&&e.user))throw new Error("Not authenticated");const{data:r,error:n}=await c.from("profiles").select("full_name, phone, mobile_phone, email, role, org_id, home_address, emergency_contact").eq("id",e.user.id).single();if(n||!r)return null;const s=r.org_id?await Y(r.org_id):null;return{fullName:r.full_name||"",phone:r.mobile_phone||r.phone||"",email:r.email||"",role:r.role||"GENERAL_USER",communityId:s||"",address:r.home_address||"",emergencyContactName:((i=r.emergency_contact)==null?void 0:i.name)||"",emergencyContactPhone:((o=r.emergency_contact)==null?void 0:o.phone)||"",emergencyContactRelation:((d=r.emergency_contact)==null?void 0:d.relation)||""}}async function je(){const{data:e,error:t}=await c.auth.getUser();if(t||!(e!=null&&e.user))throw new Error("Not authenticated");const{data:r,error:n}=await c.from("vitals").select("household, pet_details, medical_needs, household_size, medication_dependency, insulin_dependency, oxygen_powered_device, mobility_limitation, transportation_access, financial_strain, zip_code, consent_preparedness_planning, consent_timestamp").eq("profile_id",e.user.id).single();return n||!r?null:{household:r.household||[],householdMembers:Number(r.household_size||(r.household||[]).length||1),petDetails:r.pet_details||"",medicalNeeds:r.medical_needs||"",zipCode:r.zip_code||"",medicationDependency:!!r.medication_dependency,insulinDependency:!!r.insulin_dependency,oxygenPoweredDevice:!!r.oxygen_powered_device,mobilityLimitation:!!r.mobility_limitation,transportationAccess:!!r.transportation_access,financialStrain:!!r.financial_strain,consentPreparednessPlanning:!!r.consent_preparedness_planning,consentTimestamp:r.consent_timestamp||void 0}}async function Ke(e){const t=await V(e);if(!t)throw new Error("Organization not found");const{data:r,error:n}=await c.from("inventory").select("water, food, blankets, medical_kits").eq("org_id",t.orgId).maybeSingle();if(n)throw new Error("Failed to load inventory");return r?qe(r):{water:0,food:0,blankets:0,medicalKits:0}}async function We(e,t){var o;const r=await v(e);if(!r)throw new Error("Organization not found");const{data:n}=await c.auth.getUser(),s=((o=n==null?void 0:n.user)==null?void 0:o.id)||null,{error:i}=await c.from("inventory").upsert({org_id:r,water:t.water,food:t.food,blankets:t.blankets,medical_kits:t.medicalKits,last_updated_by:s},{onConflict:"org_id"});if(i)throw new Error("Failed to save inventory");await E({action:"UPDATE",entityType:"inventory",orgCode:e,details:t})}async function Kt(e){const t=await V(e);if(!t)throw new Error("Organization not found");const{data:r,error:n}=await c.from("replenishment_requests").select("id, org_id, org_name, item, quantity, status, provider, created_at, delivered_quantity").eq("org_id",t.orgId).order("created_at",{ascending:!1});if(n)throw new Error("Failed to load requests");return(r||[]).map(s=>({id:s.id,orgId:t.orgCode,orgName:s.org_name||t.orgName||"",item:s.item,quantity:s.quantity,status:L(s.status),timestamp:s.created_at,provider:s.provider||"",deliveredQuantity:s.delivered_quantity||0,synced:!0}))}async function Wt(e,t){const r=await V(e);if(!r)throw new Error("Organization not found");const{data:n,error:s}=await c.from("replenishment_requests").insert({org_id:r.orgId,org_name:t.orgName||r.orgName||"",item:t.item,quantity:t.quantity,status:"PENDING",provider:t.provider||null}).select("id, org_id, org_name, item, quantity, status, provider, created_at, delivered_quantity").single();if(s||!n)throw new Error("Failed to create request");return await E({action:"CREATE",entityType:"replenishment_requests",entityId:n.id,orgCode:e,details:{item:t.item,quantity:t.quantity}}),{id:n.id,orgId:r.orgCode,orgName:n.org_name||r.orgName||"",item:n.item,quantity:n.quantity,status:L(n.status),timestamp:n.created_at,provider:n.provider||"",deliveredQuantity:n.delivered_quantity||0,synced:!0}}async function Yt(e,t){const r=L(t.status),{data:n,error:s}=await c.from("replenishment_requests").update({status:r,delivered_quantity:t.deliveredQuantity??void 0}).eq("id",e).select("id, org_id, org_name, item, quantity, status, provider, created_at, delivered_quantity").single();if(s||!n)throw new Error("Failed to update request");const i=n.org_id?await Y(n.org_id):null;return await E({action:"UPDATE",entityType:"replenishment_requests",entityId:n.id,orgCode:i||null,details:{status:r,deliveredQuantity:t.deliveredQuantity??null}}),{id:n.id,orgId:i||"",orgName:n.org_name||"",item:n.item,quantity:n.quantity,status:L(n.status),timestamp:n.created_at,provider:n.provider||"",deliveredQuantity:n.delivered_quantity||0,synced:!0}}async function Ye(e){const t=await v(e);if(!t)throw new Error("Organization not found");const{data:r,error:n}=await c.from("member_statuses").select("member_id, name, status, last_check_in").eq("org_id",t);if(n)throw new Error("Failed to load member status");const s=(r||[]).map(o=>({id:o.member_id,name:o.name,status:o.status||"UNKNOWN",lastUpdate:o.last_check_in||""}));return{counts:s.reduce((o,d)=>(d.status==="SAFE"?o.safe+=1:d.status==="DANGER"?o.danger+=1:o.unknown+=1,o),{safe:0,danger:0,unknown:0}),members:s}}async function Qe(e,t){const r=await v(e);if(!r)throw new Error("Organization not found");const{error:n}=await c.from("member_statuses").upsert({org_id:r,member_id:t.memberId,name:t.name||"Unknown",status:t.status,last_check_in:new Date().toISOString()},{onConflict:"org_id,member_id"});if(n)throw new Error("Failed to save member status");return await E({action:"UPDATE",entityType:"member_statuses",entityId:t.memberId,orgCode:e,details:{status:t.status}}),{ok:!0}}async function Qt(e){const t=await v(e);if(!t)throw new Error("Organization not found");const{data:r,error:n}=await c.from("broadcasts").select("message").eq("org_id",t).maybeSingle();if(n)throw new Error("Failed to load broadcast");return r||{message:""}}async function Je(e,t){var o;const r=await v(e);if(!r)throw new Error("Organization not found");const{data:n}=await c.auth.getUser(),s=((o=n==null?void 0:n.user)==null?void 0:o.id)||null,{error:i}=await c.from("broadcasts").upsert({org_id:r,message:t,posted_by:s},{onConflict:"org_id"});if(i)throw new Error("Failed to save broadcast");return await E({action:"UPDATE",entityType:"broadcasts",orgCode:e}),{message:t}}async function $e(e){var _,h,w,N,y,f,I;const{email:t,phone:r,password:n,fullName:s,role:i,orgId:o}=e,{data:d,error:a}=await c.auth.signUp({email:t||void 0,phone:r||void 0,password:n,options:{data:{full_name:s||"",role:i||"GENERAL_USER",org_code:o||""}}});if(a)throw a;const m=(_=d.user)==null?void 0:_.id;let u=null;return o&&(u=await v(o)),m&&((h=d.session)!=null&&h.access_token)&&await c.from("profiles").upsert({id:m,email:((w=d.user)==null?void 0:w.email)||t||null,phone:r||null,full_name:s||null,role:i||"GENERAL_USER",org_id:u}),{token:((N=d.session)==null?void 0:N.access_token)||null,refreshToken:((y=d.session)==null?void 0:y.refresh_token)||null,needsEmailConfirm:!((f=d.session)!=null&&f.access_token),user:{id:m,email:((I=d.user)==null?void 0:I.email)||t||"",phone:r||"",fullName:s||"",role:i||"GENERAL_USER",orgId:o||""}}}async function Ze(e){var o,d,a,m;if(!e.email&&!e.phone)throw new Error("Email or phone required");const{data:t,error:r}=await c.auth.signInWithPassword({email:e.email||void 0,password:e.password});if(r)throw r;const n=((o=t.user)==null?void 0:o.id)||"",s=n?await G(n):null,i=s!=null&&s.org_id?await Y(s.org_id):null;return{token:((d=t.session)==null?void 0:d.access_token)||null,refreshToken:((a=t.session)==null?void 0:a.refresh_token)||null,user:{id:n,email:((m=t.user)==null?void 0:m.email)||e.email||"",phone:(s==null?void 0:s.phone)||"",fullName:(s==null?void 0:s.full_name)||"",role:(s==null?void 0:s.role)||"GENERAL_USER",orgId:i||""}}}async function Xe(e){const t=typeof window<"u"?`${window.location.origin}/reset-password`:void 0,{error:r}=await c.auth.resetPasswordForEmail(e.email,{redirectTo:t});if(r)throw r;return{ok:!0}}async function et(e){if(e.token){const{error:r}=await c.auth.verifyOtp({type:"recovery",token:e.token,email:e.email});if(r)throw r}const{error:t}=await c.auth.updateUser({password:e.newPassword});if(t)throw t;return{ok:!0}}async function Jt(e){const{data:t,error:r}=await c.functions.invoke("notify-emergency-contact",{body:e});if(r)throw r;return t}async function $t(e){const{data:t,error:r}=await c.auth.getUser();if(r||!(t!=null&&t.user))throw new Error("Not authenticated");const n=await G(t.user.id),s=(n==null?void 0:n.org_id)||null;let i=null;if(e.imageDataUrl){const a=await xe(e.imageDataUrl),m=`${t.user.id}/${Date.now()}.jpg`,{error:u}=await c.storage.from("assessment_photos").upload(m,a,{contentType:"image/jpeg"});if(u)throw u;i=m}const{data:o,error:d}=await c.from("damage_assessments").insert({profile_id:t.user.id,org_id:s,damage_type:e.damageType,severity:e.severity,description:e.description||null,photo_path:i}).select("id, photo_path").single();if(d||!o)throw new Error("Failed to submit assessment");return await E({action:"CREATE",entityType:"damage_assessments",entityId:o.id,details:{damageType:e.damageType,severity:e.severity}}),o}async function Zt(e,t=3600){const{data:r,error:n}=await c.storage.from("assessment_photos").createSignedUrl(e,t);if(n||!(r!=null&&r.signedUrl))throw new Error("Failed to create signed URL");return r.signedUrl}async function Xt(e=75){const{data:t,error:r}=await c.auth.getUser();if(r||!(t!=null&&t.user))throw new Error("Not authenticated");const n=await G(t.user.id),s=String((n==null?void 0:n.role)||"GENERAL_USER").toUpperCase(),i=s==="ADMIN"||s==="STATE_ADMIN"||s==="COUNTY_ADMIN",o=s==="ORG_ADMIN"||s==="INSTITUTION_ADMIN";if(!i&&!o)return[];let d=c.from("damage_assessments").select("id, profile_id, org_id, damage_type, severity, description, photo_path, location, created_at").order("created_at",{ascending:!1}).limit(Math.max(1,Math.min(e,200)));if(o){if(!(n!=null&&n.org_id))return[];d=d.eq("org_id",n.org_id)}const{data:a,error:m}=await d;if(m)throw new Error("Failed to load assessment results");const u=Array.from(new Set((a||[]).map(f=>f.profile_id).filter(Boolean))),_=Array.from(new Set((a||[]).map(f=>f.org_id).filter(Boolean))),[h,w]=await Promise.all([u.length?c.from("profiles").select("id, full_name, email, phone").in("id",u):Promise.resolve({data:[],error:null}),_.length?c.from("organizations").select("id, org_code, name").in("id",_):Promise.resolve({data:[],error:null})]);if(h.error)throw new Error("Failed to resolve assessment reporters");if(w.error)throw new Error("Failed to resolve assessment organizations");const N=new Map((h.data||[]).map(f=>[f.id,f])),y=new Map((w.data||[]).map(f=>[f.id,f]));return(a||[]).map(f=>{const I=N.get(f.profile_id),S=f.org_id?y.get(f.org_id):null;return{id:f.id,profileId:f.profile_id,orgId:f.org_id||null,orgName:(S==null?void 0:S.name)||null,orgCode:(S==null?void 0:S.org_code)||null,reporterName:(I==null?void 0:I.full_name)||"Unknown Reporter",reporterEmail:(I==null?void 0:I.email)||null,reporterPhone:(I==null?void 0:I.phone)||null,damageType:f.damage_type,severity:Number(f.severity||1),description:f.description||null,photoPath:f.photo_path||null,location:f.location||null,createdAt:f.created_at}})}async function $(e,t){const r=t!=null&&t.orgId?await v(t.orgId):null,{data:n,error:s}=await c.from("help_requests").insert({user_id:e,org_id:r,status:t.status||"RECEIVED",priority:t.priority||"LOW",data:t.data||{},location:t.location||null}).select("id, user_id, status, priority, data, location, created_at").single();if(s||!n)throw new Error("Failed to create help request");return await E({action:"CREATE",entityType:"help_requests",entityId:n.id,orgCode:(t==null?void 0:t.orgId)||null}),{id:n.id,userId:n.user_id,status:n.status,priority:n.priority,data:n.data,location:n.location,timestamp:n.created_at}}async function tt(e){const{data:t,error:r}=await c.from("help_requests").select("id, user_id, status, priority, data, location, created_at").eq("user_id",e).order("created_at",{ascending:!1}).limit(1).maybeSingle();if(r)throw new Error("Failed to load help request");return t?{id:t.id,userId:t.user_id,status:t.status,priority:t.priority,data:t.data,location:t.location,timestamp:t.created_at}:null}async function Z(e,t){const{error:r}=await c.from("help_requests").update({location:t}).eq("id",e);if(r)throw new Error("Failed to update help request location");return await E({action:"UPDATE",entityType:"help_requests",entityId:e,details:{location:t}}),{ok:!0}}async function nt(e){const t=await v(e);if(!t)throw new Error("Organization not found");const{data:r,error:n}=await c.from("members").select("id, name, status, location, last_update, needs, phone, address, emergency_contact_name, emergency_contact_phone, emergency_contact_relation").eq("org_id",t).order("created_at",{ascending:!1});if(n)throw new Error("Failed to load members");return r||[]}async function rt(e,t){const r=await v(e);if(!r)throw new Error("Organization not found");const{data:n,error:s}=await c.from("members").insert({org_id:r,name:t.name,status:t.status||"UNKNOWN",location:t.location||null,last_update:t.lastUpdate||null,needs:t.needs||[],phone:t.phone||null,address:t.address||null,emergency_contact_name:t.emergencyContactName||null,emergency_contact_phone:t.emergencyContactPhone||null,emergency_contact_relation:t.emergencyContactRelation||null}).select("id, name, status, location, last_update, needs, phone, address, emergency_contact_name, emergency_contact_phone, emergency_contact_relation").single();if(s||!n)throw new Error("Failed to add member");return await E({action:"CREATE",entityType:"members",entityId:n.id,orgCode:e}),n}async function st(e,t,r){const n=await v(e);if(!n)throw new Error("Organization not found");const{data:s,error:i}=await c.from("members").update({name:r.name,status:r.status,location:r.location,last_update:r.lastUpdate,needs:r.needs,phone:r.phone,address:r.address,emergency_contact_name:r.emergencyContactName,emergency_contact_phone:r.emergencyContactPhone,emergency_contact_relation:r.emergencyContactRelation}).eq("id",t).eq("org_id",n).select("id, name, status, location, last_update, needs, phone, address, emergency_contact_name, emergency_contact_phone, emergency_contact_relation").single();if(i||!s)throw new Error("Failed to update member");return await E({action:"UPDATE",entityType:"members",entityId:s.id,orgCode:e}),s}async function it(e,t){const r=await v(e);if(!r)throw new Error("Organization not found");const{error:n}=await c.from("members").delete().eq("id",t).eq("org_id",r);if(n)throw new Error("Failed to remove member");return await E({action:"DELETE",entityType:"members",entityId:t,orgCode:e}),{ok:!0}}const U="aera_backend_db_v4",q="aera_auth_token",x="aera_refresh_token",X="aera_offline_queue_v1",ee="aera_sync_id_map_v1",_e="aera_storage_state_v1",te="aera_role_definitions_v1",ot=200,at=200,dt=e=>{const t=e;return(t==null?void 0:t.name)==="QuotaExceededError"||(t==null?void 0:t.code)===22||(t==null?void 0:t.code)===1014||((t==null?void 0:t.message)||"").toLowerCase().includes("quota")},A=e=>{try{return localStorage.getItem(e)}catch(t){return console.warn("localStorage getItem failed",{key:e,error:t}),null}},D=(e,t)=>{try{return localStorage.setItem(e,t),!0}catch(r){return dt(r)?(console.warn("localStorage quota exceeded, will attempt cleanup",{key:e}),!1):(console.error("localStorage setItem failed",{key:e,error:r}),!1)}},C=e=>{try{localStorage.removeItem(e)}catch(t){console.warn("localStorage removeItem failed",{key:e,error:t})}},ct=e=>({...e,orgMembers:{},requests:(e.requests||[]).slice(0,ot),replenishmentRequests:(e.replenishmentRequests||[]).slice(0,at)}),M=e=>{D(_e,JSON.stringify({...e,timestamp:new Date().toISOString()}))},ne=e=>({water:Math.max(0,Number(e.water)||0),food:Math.max(0,Number(e.food)||0),blankets:Math.max(0,Number(e.blankets)||0),medicalKits:Math.max(0,Number(e.medicalKits)||0)}),ut=[{id:"CH-9921",name:"Grace Community Church",type:"CHURCH",address:"4500 Main St",adminContact:"Pastor John",adminPhone:"555-0101",replenishmentProvider:"Diocese HQ",replenishmentEmail:"supply@diocese.example.org",replenishmentPhone:"555-9000",verified:!0,active:!0,registeredPopulation:200,currentBroadcast:"Choir practice cancelled. Shelter open in Gym."},{id:"NGO-5500",name:"Regional Aid Network",type:"NGO",address:"100 Relief Blvd",adminContact:"Sarah Connor",adminPhone:"555-0102",replenishmentProvider:"FEMA Region 4",replenishmentEmail:"logistics@fema.example.gov",replenishmentPhone:"555-9001",verified:!0,active:!0,registeredPopulation:1200}],T=new Date().toISOString(),re=[{id:"u0",fullName:"System Admin",email:"admin@example.com",createdAt:T,phone:"555-0000",address:"HQ",householdMembers:1,household:[],petDetails:"",medicalNeeds:"",emergencyContactName:"Ops Center",emergencyContactPhone:"555-9999",emergencyContactRelation:"Supervisor",communityId:"",role:"ADMIN",language:"en",active:!0,onboardComplete:!0,notifications:{push:!0,sms:!0,email:!0}},{id:"u1",fullName:"Alice Johnson",email:"alice@example.com",createdAt:T,phone:"555-1001",address:"101 Pine St",householdMembers:3,household:[{id:"h1",name:"Bob Johnson",age:"35",needs:""},{id:"h2",name:"Timmy Johnson",age:"8",needs:"Asthma"}],petDetails:"1 Cat",medicalNeeds:"",emergencyContactName:"Bob Johnson",emergencyContactPhone:"555-2001",emergencyContactRelation:"Spouse",communityId:"CH-9921",role:"GENERAL_USER",language:"en",active:!0,onboardComplete:!0,notifications:{push:!0,sms:!0,email:!0}},{id:"u2",fullName:"David Brown",email:"david@example.com",createdAt:T,phone:"555-1002",address:"202 Oak Ave",householdMembers:1,household:[],petDetails:"",medicalNeeds:"Insulin Dependent",emergencyContactName:"Martha Brown",emergencyContactPhone:"555-2002",emergencyContactRelation:"Mother",communityId:"CH-9921",role:"GENERAL_USER",language:"en",active:!0,onboardComplete:!0,notifications:{push:!0,sms:!0,email:!0}},{id:"u3",fullName:"Pastor John",email:"pastor@example.com",createdAt:T,phone:"555-0101",address:"4500 Main St",householdMembers:4,household:[{id:"h3",name:"Mary Smith",age:"45",needs:""},{id:"h4",name:"Luke Smith",age:"12",needs:""},{id:"h5",name:"Mark Smith",age:"10",needs:""}],petDetails:"",medicalNeeds:"",emergencyContactName:"Church Office",emergencyContactPhone:"555-0100",emergencyContactRelation:"Work",communityId:"CH-9921",role:"INSTITUTION_ADMIN",language:"en",active:!0,onboardComplete:!0,notifications:{push:!0,sms:!0,email:!0}},{id:"u4",fullName:"Sarah Connor",email:"sarah@example.com",createdAt:T,phone:"555-9111",address:"Fire Station 1",householdMembers:1,household:[],petDetails:"",medicalNeeds:"",emergencyContactName:"Dispatcher",emergencyContactPhone:"555-9000",emergencyContactRelation:"Work",communityId:"",role:"FIRST_RESPONDER",language:"en",active:!0,onboardComplete:!0,notifications:{push:!0,sms:!0,email:!0}}],lt={"CH-9921":{water:120,food:45,blankets:300,medicalKits:15},"NGO-5500":{water:5e3,food:2e3,blankets:1e3,medicalKits:500}},mt=[{id:"req-1",orgId:"CH-9921",orgName:"Grace Community Church",item:"Water Cases",quantity:50,status:"PENDING",timestamp:new Date(Date.now()-36e5).toISOString(),provider:"Diocese HQ",synced:!0},{id:"req-2",orgId:"NGO-5500",orgName:"Regional Aid Network",item:"Medical Kits",quantity:200,status:"FULFILLED",timestamp:new Date(Date.now()-864e5).toISOString(),provider:"FEMA Region 4",synced:!0}],se={getDB(){try{const e=A(U);if(e){const t=JSON.parse(e);return t.orgMembers||(t.orgMembers={}),t}}catch(e){console.error("DB Load Error",e)}return this.seedDB()},saveDB(e){try{if(D(U,JSON.stringify(e)))M({degraded:!1});else{const r=ct(e);D(U,JSON.stringify(r))?M({degraded:!0,lastError:"Pruned database due to quota limits"}):(M({degraded:!0,lastError:"Unable to persist after pruning"}),console.error("DB Save Error: Unable to persist even after pruning"))}}catch(t){M({degraded:!0,lastError:String(t)}),console.error("DB Save Error",t)}},getStorageState(){const e=A(_e);if(!e)return{degraded:!1};try{return JSON.parse(e)||{degraded:!1}}catch{return{degraded:!1}}},shouldUseBackendAsSourceOfTruth(){return!!this.getStorageState().degraded},getSyncIdMap(){const e=A(ee);if(!e)return{};try{const t=JSON.parse(e);return t&&typeof t=="object"?t:{}}catch(t){return console.warn("Failed to parse sync id map",t),{}}},saveSyncIdMap(e){D(ee,JSON.stringify(e))},seedDB(){console.log("Seeding database with users:",re.map(t=>({id:t.id,name:t.fullName,onboardComplete:t.onboardComplete})));const e={users:re,organizations:ut,inventories:lt,requests:[],replenishmentRequests:mt,orgMembers:{},currentUser:null,tickerMessage:""};return this.saveDB(e),e},resetDB(){C(U),C(q),C(x),window.location.reload()},getRoles(){const e=A(te);if(!e)return null;try{const t=JSON.parse(e);return Array.isArray(t)?t:null}catch(t){return console.warn("Failed to parse role definitions",t),null}},saveRoles(e){D(te,JSON.stringify(e))},setAuthToken(e){D(q,e)},setRefreshToken(e){D(x,e)},getAuthToken(){return A(q)},getRefreshToken(){return A(x)},clearAuthToken(){C(q),C(x)},getOfflineQueue(){const e=A(X);if(!e)return[];try{const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch(t){return console.warn("Failed to parse offline queue",t),[]}},saveOfflineQueue(e){D(X,JSON.stringify(e))},enqueueOfflineOperation(e){var n;const t=this.getOfflineQueue(),r={...e,id:`op_${Date.now()}_${Math.random().toString(36).slice(2,8)}`,timestamp:new Date().toISOString()};if(r.type==="updateHelpRequestLocation"&&((n=r.payload)!=null&&n.requestId)){const s=t.findIndex(i=>{var o;return i.type==="updateHelpRequestLocation"&&((o=i.payload)==null?void 0:o.requestId)===r.payload.requestId});if(s>=0){t[s]=r,this.saveOfflineQueue(t);return}}t.push(r),this.saveOfflineQueue(t)},startOfflineSyncListener(){if(typeof window>"u")return;const e="__aera_offline_sync_listener__";window[e]||(window[e]=!0,window.addEventListener("online",()=>{this.syncPendingData().catch(t=>console.warn("Offline sync failed",t))}))},async registerWithCredentials(e,t,r){const n=await $e({email:e,password:t,fullName:r});if(n!=null&&n.token&&this.setAuthToken(n.token),n!=null&&n.refreshToken&&this.setRefreshToken(n.refreshToken),n!=null&&n.user){const s={id:n.user.id,fullName:n.user.fullName||r||"",email:n.user.email||"",phone:n.user.phone||"",address:"",householdMembers:1,household:[],petDetails:"",medicalNeeds:"",emergencyContactName:"",emergencyContactPhone:"",emergencyContactRelation:"",communityId:n.user.orgId||"",role:n.user.role||"GENERAL_USER",language:"en",active:!0,onboardComplete:!1,notifications:{push:!0,sms:!0,email:!0}};this.saveProfile(s)}return n},async loginWithCredentials(e,t){this.getDB();try{const r=await Ze({email:e,password:t});if(r!=null&&r.token&&this.setAuthToken(r.token),r!=null&&r.refreshToken&&this.setRefreshToken(r.refreshToken),r!=null&&r.user){const[n,s]=await Promise.all([He(),je()]),i=await he()||await fe(),o={id:r.user.id,fullName:(n==null?void 0:n.fullName)||r.user.fullName||"",email:(n==null?void 0:n.email)||r.user.email||"",phone:(n==null?void 0:n.phone)||r.user.phone||"",address:(n==null?void 0:n.address)||"",householdMembers:(s==null?void 0:s.householdMembers)||1,household:(s==null?void 0:s.household)||[],petDetails:(s==null?void 0:s.petDetails)||"",medicalNeeds:(s==null?void 0:s.medicalNeeds)||"",emergencyContactName:(n==null?void 0:n.emergencyContactName)||"",emergencyContactPhone:(n==null?void 0:n.emergencyContactPhone)||"",emergencyContactRelation:(n==null?void 0:n.emergencyContactRelation)||"",householdId:i==null?void 0:i.householdId,householdName:i==null?void 0:i.householdName,householdCode:i==null?void 0:i.householdCode,householdRole:i==null?void 0:i.householdRole,communityId:(n==null?void 0:n.communityId)||r.user.orgId||"",role:r.user.role||"GENERAL_USER",language:"en",active:!0,onboardComplete:!1,notifications:{push:!0,sms:!0,email:!0}};this.saveProfile(o)}return r}catch(r){const n=(r==null?void 0:r.message)||"Login failed. Please check your credentials.";throw new Error(n)}},async requestPasswordReset(e){return Xe({email:e})},async resetPassword(e,t,r){return et({email:e,token:t,newPassword:r})},hasProfile(){return!!this.getDB().currentUser},getProfile(){const e=this.getDB();if(console.log("getProfile called, currentUser:",e.currentUser),!e.currentUser)return this.createGuestProfile();const t=e.users.find(r=>r.id===e.currentUser);return console.log("Found user profile:",t?{id:t.id,name:t.fullName,onboardComplete:t.onboardComplete}:"NOT FOUND"),t||this.createGuestProfile()},createGuestProfile(){return{id:"guest",fullName:"",email:"",phone:"",address:"",householdMembers:1,household:[],petDetails:"",medicalNeeds:"",emergencyContactName:"",emergencyContactPhone:"",emergencyContactRelation:"",communityId:"",role:"GENERAL_USER",language:"en",active:!0,notifications:{push:!0,sms:!0,email:!0}}},saveProfile(e){var s;const t=this.getDB();(!e.id||e.id==="guest")&&(e.id="u_"+Date.now());const r=t.users.find(i=>i.id===e.id);!e.createdAt&&(r!=null&&r.createdAt)&&(e.createdAt=r.createdAt),!e.createdAt&&!r&&(e.createdAt=new Date().toISOString()),e.householdMembers=(((s=e.household)==null?void 0:s.length)||0)+1,e.active===void 0&&(e.active=!0),e.onboardComplete===void 0&&(e.onboardComplete=!1);const n=t.users.findIndex(i=>i.id===e.id);return n>=0?t.users[n]=e:t.users.push(e),t.currentUser=e.id,this.saveDB(t),e.id&&e.id!=="guest"&&(async()=>{try{await Be({fullName:e.fullName,phone:e.phone,email:e.email,address:e.address,emergencyContactName:e.emergencyContactName,emergencyContactPhone:e.emergencyContactPhone,emergencyContactRelation:e.emergencyContactRelation,communityId:e.communityId,role:e.role}),await ze({household:e.household||[],householdMembers:e.householdMembers,petDetails:e.petDetails||"",medicalNeeds:e.medicalNeeds||""}),await Fe(e.household||[]),await Ve(e.petDetails||""),await Ge({communityId:e.communityId,fullName:e.fullName,phone:e.phone,address:e.address,emergencyContactName:e.emergencyContactName,emergencyContactPhone:e.emergencyContactPhone,emergencyContactRelation:e.emergencyContactRelation})}catch(i){console.warn("Supabase profile sync failed",i)}})(),!0},loginUser(e){const t=this.getDB(),r=t.users.find(n=>n.phone===e);return console.log("loginUser called with phone:",e),console.log("Found user:",r?{id:r.id,name:r.fullName,onboardComplete:r.onboardComplete}:"NOT FOUND"),r?r.active===!1?{success:!1,message:"Account deactivated. Contact Admin."}:(t.currentUser=r.id,this.saveDB(t),console.log("User logged in, currentUser set to:",r.id),{success:!0}):{success:!1,message:"User not found. Please check number or register."}},logoutUser(){const e=this.getDB();e.currentUser=null,this.saveDB(e),C(q),C(x)},updateUserStatus(e,t){const r=this.getDB(),n=r.users.findIndex(s=>s.id===e);if(n>=0){if(r.currentUser===e&&!t){alert("Cannot deactivate your own account while logged in.");return}r.users[n].active=t,this.saveDB(r)}},saveOrganization(e){const t=this.getDB();e.active===void 0&&(e.active=!0);const r=t.organizations.findIndex(n=>n.id===e.id);if(r>=0?t.organizations[r]=e:t.organizations.push(e),t.inventories[e.id]||(t.inventories[e.id]={water:0,food:0,blankets:0,medicalKits:0}),t.currentUser){const n=t.users.findIndex(s=>s.id===t.currentUser);n>=0&&(t.users[n].role="INSTITUTION_ADMIN",t.users[n].communityId=e.id)}return this.saveDB(t),!0},updateOrgStatus(e,t){const r=this.getDB(),n=r.organizations.findIndex(s=>s.id===e);n>=0&&(r.organizations[n].active=t,this.saveDB(r))},generateOrgId(e){const t=e==="CHURCH"?"CH":e==="NGO"?"NGO":"ORG",r=Math.floor(1e3+Math.random()*9e3);return`${t}-${r}`},getOrganization(e){return this.getDB().organizations.find(r=>r.id===e)||null},getAllOrganizations(){return this.getDB().organizations},getOrgInventory(e){return this.getDB().inventories[e]||{water:0,food:0,blankets:0,medicalKits:0}},async fetchOrgInventoryRemote(e){try{return{inventory:await Ke(e),fromCache:!1}}catch(t){return console.warn("API inventory fetch failed, falling back to local",t),{inventory:this.getOrgInventory(e),fromCache:!0}}},async saveOrgInventoryRemote(e,t){try{const r=ne(t);return await We(e,r),this.saveOrgInventory(e,r),!0}catch(r){return console.warn("API inventory save failed, keeping local only",r),!1}},async fetchMemberStatus(e){try{return await Ye(e)}catch(t){return console.warn("API member status fetch failed",t),null}},async saveMemberStatus(e,t,r,n){try{return await Qe(e,{memberId:t,name:r,status:n})}catch(s){return console.warn("API member status save failed",s),null}},updateOrgInventory(e,t){const r=this.getDB(),n=ne(t);r.inventories[e]=n,this.saveDB(r),typeof window<"u"&&window.dispatchEvent(new Event("inventory-update"))},submitReplenishmentRequest(e,t,r){const n=this.getDB(),s=n.organizations.find(d=>d.id===e);if(!s||!De[t])return!1;const i=navigator.onLine,o={id:"RR-"+Date.now(),orgId:s.id,orgName:s.name,item:t,quantity:r,status:"PENDING",timestamp:new Date().toISOString(),provider:s.replenishmentProvider||"Unknown",synced:i};return n.replenishmentRequests||(n.replenishmentRequests=[]),n.replenishmentRequests.unshift(o),this.saveDB(n),!0},createReplenishmentRequest(e,t){const r=this.getDB(),n=r.organizations.find(o=>o.id===e);if(!n)return!1;const s=navigator.onLine,i={id:"RR-"+Date.now(),orgId:n.id,orgName:t.orgName||n.name,item:t.item,quantity:t.quantity,status:"PENDING",timestamp:new Date().toISOString(),provider:t.provider||n.replenishmentProvider||"Unknown",synced:s};return r.replenishmentRequests||(r.replenishmentRequests=[]),r.replenishmentRequests.unshift(i),this.saveDB(r),!0},getAllReplenishmentRequests(){return this.getDB().replenishmentRequests||[]},getReplenishmentAggregation(){const t=this.getDB().replenishmentRequests||[],r={};return t.forEach(n=>{r[n.item]||(r[n.item]={item:n.item,pending:0,approved:0,fulfilled:0,totalRequested:0,pendingQuantity:0});const s=r[n.item];s.totalRequested+=n.quantity||0,n.status==="PENDING"?(s.pending+=1,s.pendingQuantity+=n.quantity||0):n.status==="APPROVED"?(s.approved+=1,s.pendingQuantity+=n.quantity||0):(n.status==="FULFILLED"||n.status==="STOCKED")&&(s.fulfilled+=1)}),Object.values(r).sort((n,s)=>s.pendingQuantity-n.pendingQuantity)},getOrgReplenishmentRequests(e){return(this.getDB().replenishmentRequests||[]).filter(n=>n.orgId===e).sort((n,s)=>new Date(s.timestamp).getTime()-new Date(n.timestamp).getTime())},fulfillReplenishmentRequest(e,t,r="FULFILLED",n=!1){const s=this.getDB(),i=s.replenishmentRequests.findIndex(d=>d.id===e);if(i===-1)return!1;const o=s.replenishmentRequests[i];if(s.replenishmentRequests[i].status=r,s.replenishmentRequests[i].fulfilledAt=new Date().toISOString(),s.replenishmentRequests[i].orgConfirmed=n,n){s.replenishmentRequests[i].orgConfirmedAt=new Date().toISOString();const d=this.getOrgInventory(o.orgId),a={water:d.water+(Number(t.water)||0),food:d.food+(Number(t.food)||0),blankets:d.blankets+(Number(t.blankets)||0),medicalKits:d.medicalKits+(Number(t.medicalKits)||0)};this.updateOrgInventory(o.orgId,a)}return this.saveDB(s),!0},stockReplenishmentRequest(e,t){const r=this.getDB(),n=r.replenishmentRequests.findIndex(d=>d.id===e);if(n===-1)return!1;const s=r.replenishmentRequests[n],i=this.getOrgInventory(s.orgId),o={water:i.water+(Number(t.water)||0),food:i.food+(Number(t.food)||0),blankets:i.blankets+(Number(t.blankets)||0),medicalKits:i.medicalKits+(Number(t.medicalKits)||0)};return r.replenishmentRequests[n].stocked=!0,r.replenishmentRequests[n].stockedAt=new Date().toISOString(),r.replenishmentRequests[n].stockedQuantity=Object.values(t).reduce((d,a)=>d+(Number(a)||0),0),r.replenishmentRequests[n].status="STOCKED",this.updateOrgInventory(s.orgId,o),this.saveDB(r),typeof window<"u"&&window.dispatchEvent(new Event("inventory-update")),!0},stockReplenishment(e,t){return this.stockReplenishmentRequest(e,t)},updateReplenishmentRequestStatus(e,t){const r=this.getDB(),n=r.replenishmentRequests.findIndex(s=>s.id===e);n>=0&&(r.replenishmentRequests[n].status=t,this.saveDB(r))},signReplenishmentRequest(e,t,r="RELEASE"){const n=this.getDB(),s=n.replenishmentRequests.findIndex(i=>i.id===e);s>=0&&(r==="RELEASE"?(n.replenishmentRequests[s].signature=t,n.replenishmentRequests[s].signedAt=new Date().toISOString()):r==="RECEIVE"&&(n.replenishmentRequests[s].receivedSignature=t,n.replenishmentRequests[s].receivedAt=new Date().toISOString()),this.saveDB(n))},getOrgMembersLocal(e){const t=this.getDB();return t.users.filter(n=>n.communityId===e).map(n=>{const i=t.requests.filter(u=>u.userId===n.id).sort((u,_)=>new Date(_.timestamp).getTime()-new Date(u.timestamp).getTime())[0];let o="UNKNOWN",d=[],a="Never",m="Unknown";return i&&(o=i.isSafe?"SAFE":"DANGER",a=new Date(i.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),m=i.location,i.hasFood===!1&&d.push("Food"),i.hasWater===!1&&d.push("Water"),i.isInjured&&d.push("Medical"),i.isSafe||d.push("Rescue")),{id:n.id,name:n.fullName,status:o,lastUpdate:a,location:m,needs:d,phone:n.phone,address:n.address,emergencyContactName:n.emergencyContactName||"",emergencyContactPhone:n.emergencyContactPhone||"",emergencyContactRelation:n.emergencyContactRelation||""}})},getOrgMembers(e){const t=this.getDB();return t.orgMembers&&t.orgMembers[e]?t.orgMembers[e]:this.getOrgMembersLocal(e)},async fetchOrgMembersRemote(e){try{const r=(await nt(e)).map(s=>({id:s.id||s._id,name:s.name,status:s.status||"UNKNOWN",lastUpdate:s.lastUpdate||"",location:s.location||"Unknown",needs:s.needs||[],phone:s.phone||"",address:s.address||"",emergencyContactName:s.emergencyContactName||"",emergencyContactPhone:s.emergencyContactPhone||"",emergencyContactRelation:s.emergencyContactRelation||""})),n=this.getDB();return n.orgMembers=n.orgMembers||{},n.orgMembers[e]=r,this.saveDB(n),{members:r,fromCache:!1}}catch(t){return console.warn("API members fetch failed, falling back to local",t),{members:this.getOrgMembersLocal(e),fromCache:!0}}},async addOrgMemberRemote(e,t){const r=await rt(e,t);return await this.fetchOrgMembersRemote(e),r},async updateOrgMemberRemote(e,t,r){const n=await st(e,t,r);return await this.fetchOrgMembersRemote(e),n},async deleteOrgMemberRemote(e,t){await it(e,t);const r=this.getDB();r.orgMembers=r.orgMembers||{},r.orgMembers[e]=(r.orgMembers[e]||[]).filter(n=>n.id!==t),this.saveDB(r)},async submitRequest(e){const t=this.getDB(),r=t.currentUser||"guest",n=this.calculatePriority(e),s=navigator.onLine,i=Date.now().toString(),o={...e,id:i,clientId:i,userId:r,timestamp:new Date().toISOString(),status:"RECEIVED",priority:n,synced:s};t.requests.unshift(o);const d=t.users.findIndex(u=>u.id===r);d>=0&&t.users[d].pendingStatusRequest&&delete t.users[d].pendingStatusRequest,this.saveDB(t);const a=t.users.find(u=>u.id===r),m={orgId:a==null?void 0:a.communityId,data:e,priority:n,location:e.location,status:"RECEIVED"};if(!s){if(this.enqueueOfflineOperation({type:"createHelpRequest",localRequestId:o.id,payload:{userId:r,requestPayload:m}}),a!=null&&a.communityId&&(a!=null&&a.fullName)&&e.isSafe!==null){const u=e.isSafe?"SAFE":"DANGER";this.saveMemberStatus(a.communityId,a.id,a.fullName,u)}return o}try{const u=await $(r,m),_=u.id||t.requests[0].id,h=o.clientId||o.id,w=this.getSyncIdMap();if(h&&_&&(w[h]=_,this.saveSyncIdMap(w)),t.requests[0].id=_,t.requests[0].serverId=_,t.requests[0].clientId=h,t.requests[0].synced=!0,this.saveDB(t),a!=null&&a.communityId&&(a!=null&&a.fullName)&&e.isSafe!==null){const N=e.isSafe?"SAFE":"DANGER";this.saveMemberStatus(a.communityId,a.id,a.fullName,N)}return{...e,id:_||o.id,clientId:h,serverId:_,userId:r,timestamp:u.timestamp||o.timestamp,status:u.status||"RECEIVED",priority:u.priority||n,synced:!0}}catch(u){console.warn("Help request API failed; keeping local only",u),this.enqueueOfflineOperation({type:"createHelpRequest",localRequestId:o.id,payload:{userId:r,requestPayload:m}})}if(a!=null&&a.communityId&&(a!=null&&a.fullName)&&e.isSafe!==null){const u=e.isSafe?"SAFE":"DANGER";this.saveMemberStatus(a.communityId,a.id,a.fullName,u)}return o},async updateRequestLocation(e,t){var s;const r=this.getDB(),n=r.requests.findIndex(i=>i.id===e);n>=0&&(r.requests[n].location=t,this.saveDB(r));try{if(!navigator.onLine)throw new Error("offline");const o=this.getSyncIdMap()[e]||((s=r.requests[n])==null?void 0:s.serverId)||e;await Z(o,t)}catch(i){console.warn("Failed to update request location remotely",i),this.enqueueOfflineOperation({type:"updateHelpRequestLocation",payload:{requestId:e,location:t}})}},getLastKnownLocation(){const e=this.getDB(),t=e.currentUser,r=t?e.requests.filter(i=>i.userId===t):e.requests;if(!r.length)return null;const s=[...r].sort((i,o)=>new Date(o.timestamp).getTime()-new Date(i.timestamp).getTime())[0];return s.location?{location:s.location,timestamp:s.timestamp}:null},async getActiveRequest(){var r;const e=this.getDB();if(!e.currentUser)return null;try{const n=await tt(e.currentUser);if(n)return{...n.data,id:n.id||n._id,userId:n.userId,timestamp:n.timestamp||n.createdAt,status:n.status||"RECEIVED",priority:n.priority||"LOW",synced:!0,location:n.location||((r=n.data)==null?void 0:r.location)||""}}catch(n){console.warn("API active request fetch failed, falling back to local",n)}const t=e.requests.filter(n=>n.userId===e.currentUser);return t.length>0?t[0]:null},calculatePriority(e){return e.emergencyType==="Medical"||e.emergencyType==="Fire"||e.isInjured?"CRITICAL":e.emergencyType==="Flood"||!e.canEvacuate||e.vulnerableGroups.length>0?"HIGH":e.hazardsPresent||!e.hasPower||!e.hasWater?"MEDIUM":"LOW"},sendPing(e){const t=this.getDB(),r=t.users.find(s=>s.id===t.currentUser),n=t.users.findIndex(s=>s.id===e);return n>=0&&r?(t.users[n].pendingStatusRequest={requesterName:r.fullName,timestamp:new Date().toISOString()},this.saveDB(t),!0):!1},respondToPing(e){const t=this.getDB();if(!t.currentUser)return;const r=t.currentUser,n=navigator.onLine,s=t.users.find(d=>d.id===r),i={isSafe:e,location:"Status Check Response",emergencyType:e?"Check-in":"General Emergency",isInjured:!1,injuryDetails:"",situationDescription:"Response to Institution Status Check",canEvacuate:null,hazardsPresent:null,hazardDetails:"",peopleCount:1,petsPresent:null,hasWater:null,hasFood:null,hasMeds:null,hasPower:null,hasPhone:!0,needsTransport:null,vulnerableGroups:[],medicalConditions:"",damageType:"",consentToShare:!0,id:Date.now().toString(),userId:r,timestamp:new Date().toISOString(),status:"RECEIVED",priority:e?"LOW":"HIGH",synced:n};t.requests.unshift(i);const o=t.users.findIndex(d=>d.id===r);if(o>=0&&delete t.users[o].pendingStatusRequest,this.saveDB(t),s!=null&&s.communityId&&(s!=null&&s.fullName)){const d=e?"SAFE":"DANGER";this.saveMemberStatus(s.communityId,s.id,s.fullName,d)}},getTicker(e){const t=this.getDB();if(t.tickerMessage&&t.tickerMessage.length>5)return`[SYSTEM ALERT] ${t.tickerMessage}`;if(e&&e.communityId){const r=t.organizations.find(n=>n.id===e.communityId);if(r&&r.currentBroadcast)return`[${r.name} Update] ${r.currentBroadcast}`}return"Evacuation Order in Zone 4 • Shelter capacity at 85% • High water levels reported on Main St. •"},updateSystemTicker(e){const t=this.getDB();t.tickerMessage=e,this.saveDB(t),window.dispatchEvent(new Event("ticker-update"))},updateOrgBroadcast(e,t){const r=this.getDB(),n=r.organizations.findIndex(s=>s.id===e);n>=0&&(r.organizations[n].currentBroadcast=t,r.organizations[n].lastBroadcastTime=new Date().toISOString(),this.saveDB(r),window.dispatchEvent(new Event("ticker-update")),Je(e,t).catch(s=>console.warn("Broadcast API failed",s)))},clearOrgBroadcast(e){const t=this.getDB(),r=t.organizations.findIndex(n=>n.id===e);r>=0&&(t.organizations[r].currentBroadcast=void 0,this.saveDB(t),window.dispatchEvent(new Event("ticker-update")))},async syncPendingData(){if(!navigator.onLine)return 0;const e=this.getDB(),t=this.getOfflineQueue();if(!t.length)return 0;let r=0;const n=[],s=this.getSyncIdMap(),i=new Map(Object.entries(s));for(const o of t)try{if(o.type==="createHelpRequest"){const{userId:d,requestPayload:a}=o.payload||{};if(!d||!a)throw new Error("Invalid createHelpRequest payload");const m=await $(d,a),u=o.localRequestId;if(u){const _=m.id||u;i.set(u,_),s[u]=_;const h=e.requests.findIndex(w=>w.id===u);h>=0&&(e.requests[h]={...e.requests[h],id:_,clientId:e.requests[h].clientId||u,serverId:_,timestamp:m.timestamp||e.requests[h].timestamp,status:m.status||e.requests[h].status,priority:m.priority||e.requests[h].priority,synced:!0})}r++;continue}if(o.type==="updateHelpRequestLocation"){let{requestId:d,location:a}=o.payload||{};if(d&&i.has(d)&&(d=i.get(d),o.payload.requestId=d),!d||!a)throw new Error("Invalid updateHelpRequestLocation payload");await Z(d,a),r++;continue}n.push(o)}catch(d){console.warn("Offline operation failed, will retry later",o,d),n.push(o)}return this.saveOfflineQueue(n),this.saveSyncIdMap(s),r>0&&(this.saveDB(e),typeof window<"u"&&window.dispatchEvent(new Event("storage"))),r}},ie=g.lazy(()=>b(()=>import("./SplashView-CD4pcPVj.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8])).then(e=>({default:e.SplashView}))),R=g.lazy(()=>b(()=>import("./DashboardView-CP0_Iq03.js"),__vite__mapDeps([9,1,2,3,4,10,11,6,5,12,13,7,8])).then(e=>({default:e.DashboardView}))),ht=g.lazy(()=>b(()=>import("./HelpFormView-hA3g0qS4.js"),__vite__mapDeps([14,1,2,3,4,5,12,6,7,8])).then(e=>({default:e.HelpFormView}))),ft=g.lazy(()=>b(()=>import("./SettingsView-D4ma2ld0.js"),__vite__mapDeps([15,1,2,3,4,12,5,16,6,7,8])).then(e=>({default:e.SettingsView}))),_t=g.lazy(()=>b(()=>import("./MapView-DR9-Po9M.js"),__vite__mapDeps([17,1,2,3,4,18,12,10])).then(e=>({default:e.MapView}))),gt=g.lazy(()=>b(()=>import("./GapView-ZtteFLg4.js"),__vite__mapDeps([19,1,2,3,4,5,10,6,7,8])).then(e=>({default:e.GapView}))),pt=g.lazy(()=>b(()=>import("./AssessmentView-CLV32Eh3.js"),__vite__mapDeps([20,1,2,3,4,5,12,6,7,8])).then(e=>({default:e.AssessmentView}))),wt=g.lazy(()=>b(()=>import("./PopulationView-P9MCzStU.js"),__vite__mapDeps([21,1,2,3,4,8,7])).then(e=>({default:e.PopulationView}))),yt=g.lazy(()=>b(()=>import("./RecoveryView-D5TpOlyF.js"),__vite__mapDeps([22,1,2,3,4,5])).then(e=>({default:e.RecoveryView}))),Et=g.lazy(()=>b(()=>import("./DroneView-D58Oc25c.js"),__vite__mapDeps([23,1,2,3,4,5])).then(e=>({default:e.DroneView}))),It=g.lazy(()=>b(()=>import("./LogisticsView--HDBzsdF.js"),__vite__mapDeps([24,1,2,3,4,6,11,7,8])).then(e=>({default:e.LogisticsView}))),oe=g.lazy(()=>b(()=>import("./RegistrationView-BJ4EY3tS.js"),__vite__mapDeps([25,1,2,3,4,5,12,16,6,7,8])).then(e=>({default:e.RegistrationView}))),bt=g.lazy(()=>b(()=>import("./OrgDashboardView-f_hsxNGJ.js"),__vite__mapDeps([26,1,2,3,4,5,11,6,12,18,7,8])).then(e=>({default:e.OrgDashboardView}))),vt=g.lazy(()=>b(()=>import("./LoginView-BU7xdRLv.js"),__vite__mapDeps([27,1,2,3,4,5,12,6,7,8])).then(e=>({default:e.LoginView}))),Nt=g.lazy(()=>b(()=>import("./PresentationView-B5kgLT0w.js"),__vite__mapDeps([28,1,2,3,4,5])).then(e=>({default:e.PresentationView}))),St=g.lazy(()=>b(()=>import("./PrivacyPolicyView-DcRj1VLD.js"),__vite__mapDeps([29,1,2,3,4])).then(e=>({default:e.PrivacyPolicyView}))),Rt=g.lazy(()=>b(()=>import("./ResetPasswordView-BWZH2UHC.js"),__vite__mapDeps([30,1,2,3,4,5,12,7,8])).then(e=>({default:e.ResetPasswordView})));g.lazy(()=>b(()=>import("./BuildKitView-Ce-CY2mS.js"),__vite__mapDeps([31,7,2,1,3,4,5,8])).then(e=>({default:e.BuildKitView})));const ae=g.lazy(()=>b(()=>import("./ReadinessView-7Oj4Z9Yo.js"),__vite__mapDeps([32,1,2,3,4,31,7,5,8])).then(e=>({default:e.ReadinessView}))),Dt=g.lazy(()=>b(()=>import("./ReadinessGapView-T5yOFGmk.js"),__vite__mapDeps([33,1,2,3,4,7,8])).then(e=>({default:e.ReadinessGapView})));class At extends de.Component{constructor(t){super(t),this.state={hasError:!1,message:void 0}}static getDerivedStateFromError(t){return{hasError:!0,message:String((t==null?void 0:t.message)||t||"Unknown view error")}}componentDidCatch(t){console.error("View render error:",t)}render(){return this.state.hasError?l.jsx("div",{className:"min-h-screen bg-slate-50 flex items-center justify-center p-6",children:l.jsxs("div",{className:"max-w-sm w-full bg-white border border-red-200 rounded-2xl p-5 shadow-sm",children:[l.jsx("h2",{className:"text-lg font-bold text-red-700 mb-2",children:"Screen failed to load"}),l.jsx("p",{className:"text-sm text-slate-600 mb-4",children:this.state.message||"An unexpected error occurred in this view."}),l.jsx("button",{className:"w-full bg-slate-900 text-white rounded-lg py-2.5 font-semibold",onClick:()=>{this.setState({hasError:!1,message:void 0}),this.props.onRecover()},children:"Return to Dashboard"})]})}):this.props.children}}function Ct(){var N;const[e,t]=g.useState("SPLASH"),[r,n]=g.useState(!0),[s,i]=g.useState("LOGIN"),o=!B,d=String(((N=se.getProfile())==null?void 0:N.role)||"GENERAL_USER").toUpperCase(),a=["ADMIN","STATE_ADMIN","COUNTY_ADMIN","ORG_ADMIN","INSTITUTION_ADMIN","FIRST_RESPONDER","LOCAL_AUTHORITY","CONTRACTOR"].includes(d),m=["ADMIN","STATE_ADMIN","COUNTY_ADMIN","ORG_ADMIN","INSTITUTION_ADMIN"].includes(d);g.useEffect(()=>{se.startOfflineSyncListener()},[]),g.useEffect(()=>{let y=!0;return(async()=>{const I=window.location.hash||"",S=window.location.search||"",P=window.location.pathname.includes("reset-password"),H=I.includes("type=recovery")||S.includes("type=recovery")||I.includes("reset-password"),k=P||H;try{const{data:j}=await c.auth.getSession();if(!y)return;k?(i("RESET_PASSWORD"),t("RESET_PASSWORD")):(i("LOGIN"),t("SPLASH"))}catch{if(!y)return;k?(i("RESET_PASSWORD"),t("RESET_PASSWORD")):t("SPLASH")}finally{y&&n(!1)}})(),()=>{y=!1}},[]),g.useEffect(()=>{const{data:y}=c.auth.onAuthStateChange(f=>{f==="PASSWORD_RECOVERY"&&(i("RESET_PASSWORD"),t("RESET_PASSWORD"))});return()=>{var f;(f=y==null?void 0:y.subscription)==null||f.unsubscribe()}},[]);const u=()=>{sessionStorage.setItem("splashSeen","1"),t(s)},_=()=>{sessionStorage.setItem("openFinanceOnLoad","1"),t("DASHBOARD"),window.dispatchEvent(new Event("finance-open"))},h=()=>{if(r)return l.jsx(ie,{onEnter:u,onPresentation:()=>t("PRESENTATION"),onFinance:_});switch(e){case"SPLASH":return l.jsx(ie,{onEnter:u,onPresentation:()=>t("PRESENTATION"),onFinance:_});case"PRESENTATION":return l.jsx(Nt,{setView:t});case"REGISTRATION":return l.jsx(oe,{setView:t,mode:"REGISTRATION"});case"ACCOUNT_SETUP":return l.jsx(oe,{setView:t,mode:"SETUP"});case"LOGIN":return l.jsx(vt,{setView:t});case"RESET_PASSWORD":return l.jsx(Rt,{setView:t});case"BUILD_KIT":return l.jsx(ae,{setView:t});case"READINESS":return l.jsx(ae,{setView:t});case"READINESS_GAP":return l.jsx(Dt,{setView:t});case"DASHBOARD":return l.jsx(R,{setView:t});case"HELP_WIZARD":return l.jsx(ht,{setView:t});case"SETTINGS":return l.jsx(ft,{setView:t});case"MAP":return a?l.jsx(_t,{setView:t}):l.jsx(R,{setView:t});case"ALERTS":return l.jsx(R,{setView:t});case"GAP":return l.jsx(gt,{setView:t});case"ASSESSMENT":return l.jsx(pt,{setView:t});case"POPULATION":return a?l.jsx(wt,{setView:t}):l.jsx(R,{setView:t});case"RECOVERY":return a?l.jsx(yt,{setView:t}):l.jsx(R,{setView:t});case"DRONE":return a?l.jsx(Et,{setView:t}):l.jsx(R,{setView:t});case"LOGISTICS":return a?l.jsx(It,{setView:t}):l.jsx(R,{setView:t});case"ORG_DASHBOARD":return m?l.jsx(bt,{setView:t}):l.jsx(R,{setView:t});case"PRIVACY_POLICY":return l.jsx(St,{setView:t});default:return l.jsx(R,{setView:t})}},w=e!=="SPLASH"&&e!=="PRESENTATION"&&e!=="HELP_WIZARD"&&e!=="REGISTRATION"&&e!=="ACCOUNT_SETUP"&&e!=="LOGIN"&&e!=="RESET_PASSWORD"&&e!=="BUILD_KIT"&&e!=="READINESS"&&e!=="READINESS_GAP"&&e!=="ORG_DASHBOARD"&&e!=="PRIVACY_POLICY";return l.jsxs("div",{className:"max-w-md mx-auto min-h-screen bg-slate-50 shadow-2xl relative overflow-hidden md:border-x md:border-slate-200 print:max-w-none print:w-full print:h-auto print:overflow-visible print:shadow-none print:border-0",children:[o&&l.jsx("div",{className:"absolute top-0 inset-x-0 z-50",children:l.jsxs("div",{className:"bg-amber-50 border-b border-amber-200 text-amber-900 px-4 py-2 text-xs text-center",children:[me," — set VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY, then rebuild."]})}),l.jsx(At,{onRecover:()=>t("DASHBOARD"),children:l.jsx(g.Suspense,{fallback:l.jsx("div",{className:"min-h-screen bg-slate-50 flex items-center justify-center p-6",children:l.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Loading…"})}),children:h()})}),!w&&l.jsx("div",{className:"fixed inset-x-0 bottom-4 z-40 flex justify-center print:hidden",children:l.jsx("button",{onClick:()=>{sessionStorage.setItem("privacyReturnView",e),t("PRIVACY_POLICY")},className:"text-[11px] text-slate-500 hover:text-slate-700 underline bg-white/80 px-3 py-1 rounded-full shadow-sm",children:"View Proof of Consent & Privacy Policy"})}),w&&l.jsx(Re,{currentView:e,setView:t})]})}typeof globalThis.structuredClone!="function"&&(globalThis.structuredClone=e=>JSON.parse(JSON.stringify(e)));const ge=document.getElementById("root");if(!ge)throw new Error("Could not find root element to mount to");const Ot=Ne.createRoot(ge);Ot.render(l.jsx(de.StrictMode,{children:l.jsx(Ct,{})}));export{Wt as A,Yt as B,jt as C,Me as D,Ht as E,se as S,V as a,je as b,he as c,Ft as d,fe as e,He as f,Qt as g,ze as h,Xt as i,Gt as j,Zt as k,zt as l,c as m,Jt as n,Lt as o,Fe as p,ce as q,Vt as r,$t as s,W as t,Be as u,ue as v,Ut as w,Kt as x,Mt as y,Bt as z};
