import{a,j as e,G as Y,h as Z,ak as q,l as ce,M as de,ao as V,X as xe,ap as me,aq as ue,ar as he,z as be,H as pe,D as fe,Z as ge,as as je}from"./vendor-react-DZ0IVLBb.js";import{B as x}from"./Button-BzswROfv.js";import{T as Ne}from"./Input-D28zJcRZ.js";import{t as X}from"./translations-gvebLRaU.js";import{S as ve,i as ye,k as J,s as we}from"./index-Cbj0oizH.js";import"./vendor-CCVjAPEY.js";import"./vendor-maps-S3fC-LOA.js";import"./vendor-jspdf-Bd23t5aa.js";import"./vendor-supabase-ChvUvA8t.js";const Q="Analysis: Detected significant shingle loss on approximately 40% of the visible roof surface. Potential water intrusion points identified near the chimney. Estimated Severity: High.",Ie=({setView:f})=>{const ee=s=>{const t=String(s||"GENERAL_USER").toUpperCase();return["ADMIN","CONTRACTOR","LOCAL_AUTHORITY","FIRST_RESPONDER","GENERAL_USER","INSTITUTION_ADMIN","STATE_ADMIN","COUNTY_ADMIN","ORG_ADMIN","MEMBER"].includes(t)?t:"GENERAL_USER"},[m,g]=a.useState(1),[n,se]=a.useState(null),[o,z]=a.useState(1),[D,T]=a.useState(""),[j,te]=a.useState("GENERAL_USER"),[i,I]=a.useState(!1),[u,P]=a.useState(null),[M,ae]=a.useState([]),[O,U]=a.useState({}),[h,N]=a.useState(!1),[c,v]=a.useState(null),[le,L]=a.useState(!1),l=a.useRef(null),y=a.useRef(null),[w,_]=a.useState(!1),[$,S]=a.useState(null),[G,B]=a.useState(!1),[H,F]=a.useState(null),[A,R]=a.useState(null),re=[{id:"STRUCTURAL",label:"Structure/Roof",icon:e.jsx(pe,{size:32}),color:"blue"},{id:"FLOOD",label:"Water/Flood",icon:e.jsx(fe,{size:32}),color:"cyan"},{id:"ELECTRICAL",label:"Power/Gas",icon:e.jsx(ge,{size:32}),color:"yellow"},{id:"ACCESS",label:"Blocked Road",icon:e.jsx(je,{size:32}),color:"orange"}],k=j==="ADMIN"||j==="ORG_ADMIN"||j==="INSTITUTION_ADMIN";a.useEffect(()=>()=>{C()},[]),a.useEffect(()=>{const s=ve.getProfile();te(ee(s.role))},[]);const W=async()=>{I(!0),P(null);try{const s=await ye(75);ae(s);const t=s.filter(r=>!!r.photoPath).slice(0,20);if(t.length>0){const r=await Promise.all(t.map(async d=>{try{const p=await J(d.photoPath);return[d.id,p]}catch{return[d.id,""]}})),b={};r.forEach(([d,p])=>{p&&(b[d]=p)}),U(b)}else U({})}catch(s){P((s==null?void 0:s.message)||"Unable to load assessment results.")}finally{I(!1)}};a.useEffect(()=>{k&&W()},[k]),a.useEffect(()=>{const s=t=>{h&&(t.code==="Space"||t.code==="Enter")&&(t.preventDefault(),E())};return h&&window.addEventListener("keydown",s),()=>{window.removeEventListener("keydown",s)}},[h]);const C=()=>{l.current&&l.current.srcObject&&(l.current.srcObject.getTracks().forEach(t=>t.stop()),l.current.srcObject=null)},K=async()=>{v(null),S(null);try{const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});N(!0),setTimeout(()=>{l.current&&(l.current.srcObject=s)},100)}catch(s){console.error("Camera denied",s),alert("Could not access camera. Please allow permissions.")}},E=()=>{if(l.current&&y.current){const s=l.current,t=y.current;if(s.readyState<2)return;L(!0),setTimeout(()=>L(!1),150),t.width=s.videoWidth,t.height=s.videoHeight;const r=t.getContext("2d");if(r){r.drawImage(s,0,0,t.width,t.height);const b=t.toDataURL("image/jpeg",.8);setTimeout(()=>{v(b),C(),N(!1),oe()},150)}}},oe=s=>{_(!0),setTimeout(()=>{_(!1),S(Q),T(t=>t+(t?`

`:"")+Q),z(3)},2500)},ne=()=>{v(null),S(null),K()},ie=async()=>{if(n){B(!0),F(null);try{const s=await we({damageType:n,severity:o,description:D,imageDataUrl:c||null});if(s!=null&&s.photo_path)try{const t=await J(s.photo_path);R(t)}catch{R(null)}else R(null);g(3)}catch(s){F((s==null?void 0:s.message)||"Unable to submit assessment.")}finally{B(!1)}}};return k?e.jsxs("div",{className:"min-h-screen bg-slate-50 flex flex-col pb-safe animate-fade-in",children:[e.jsx("div",{className:"bg-white border-b border-slate-200 p-4 sticky top-0 z-20",children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>f("DASHBOARD"),className:"p-2 -ml-2 text-slate-500 hover:text-slate-800",children:e.jsx(Y,{size:24})}),e.jsxs("div",{children:[e.jsx("h1",{className:"font-bold text-lg text-slate-900",children:X("dash.assess")}),e.jsx("p",{className:"text-xs text-slate-500",children:"Reported Assessment Results"})]})]}),e.jsxs(x,{size:"sm",variant:"outline",onClick:W,disabled:i,children:[e.jsx(Z,{size:14,className:"mr-1"})," Refresh"]})]})}),e.jsxs("div",{className:"p-6 space-y-4 flex-1 overflow-y-auto",children:[i&&e.jsxs("div",{className:"bg-white border border-slate-200 rounded-xl p-6 flex items-center gap-3 text-slate-600",children:[e.jsx(q,{size:18,className:"animate-spin"}),"Loading reported assessments..."]}),!i&&u&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-xl p-4 text-red-700 text-sm font-medium",children:u}),!i&&!u&&M.length===0&&e.jsxs("div",{className:"bg-white border border-slate-200 rounded-xl p-8 text-center text-slate-600",children:[e.jsx(ce,{size:24,className:"mx-auto mb-3 text-slate-400"}),"No reported assessments found yet."]}),!i&&!u&&M.map(s=>e.jsxs("div",{className:"bg-white border border-slate-200 rounded-xl p-4 shadow-sm space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-bold text-slate-900",children:s.damageType}),e.jsx("p",{className:"text-xs text-slate-500",children:new Date(s.createdAt).toLocaleString()})]}),e.jsx("span",{className:`text-xs font-bold px-2.5 py-1 rounded-full uppercase ${s.severity>=3?"bg-red-100 text-red-700":s.severity===2?"bg-yellow-100 text-yellow-700":"bg-green-100 text-green-700"}`,children:s.severity>=3?"Critical":s.severity===2?"Moderate":"Minor"})]}),(s.orgName||s.orgCode)&&e.jsxs("p",{className:"text-xs text-slate-600",children:[e.jsx("span",{className:"font-semibold text-slate-700",children:"Organization:"})," ",s.orgName||s.orgCode]}),e.jsxs("p",{className:"text-xs text-slate-600",children:[e.jsx("span",{className:"font-semibold text-slate-700",children:"Reporter:"})," ",s.reporterName,s.reporterPhone?` â€¢ ${s.reporterPhone}`:""]}),s.location&&e.jsxs("p",{className:"text-xs text-slate-600 flex items-center gap-1",children:[e.jsx(de,{size:12})," ",s.location]}),s.description&&e.jsx("p",{className:"text-sm text-slate-700 bg-slate-50 border border-slate-100 rounded-lg p-3",children:s.description}),O[s.id]&&e.jsx("img",{src:O[s.id],alt:"Damage evidence",className:"w-full max-h-56 object-cover rounded-lg border border-slate-200"})]},s.id))]})]}):e.jsxs("div",{className:"min-h-screen bg-slate-50 flex flex-col pb-safe animate-fade-in",children:[e.jsx("div",{className:"bg-white border-b border-slate-200 p-4 sticky top-0 z-20",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>m===1?f("DASHBOARD"):g(1),className:"p-2 -ml-2 text-slate-500 hover:text-slate-800",children:e.jsx(Y,{size:24})}),e.jsxs("div",{children:[e.jsx("h1",{className:"font-bold text-lg text-slate-900",children:X("dash.assess")}),e.jsx("p",{className:"text-xs text-slate-500",children:"Damage Reporting Assistant"})]})]})}),e.jsxs("div",{className:"p-6 space-y-6 flex-1 overflow-y-auto",children:[m===1&&e.jsxs("div",{className:"space-y-6 animate-slide-up",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("h2",{className:"text-xl font-bold text-slate-900 mb-2",children:"What was damaged?"}),e.jsx("p",{className:"text-slate-600 text-sm",children:"Select the category that best describes the issue."})]}),e.jsx("div",{className:"grid grid-cols-2 gap-4",children:re.map(s=>e.jsxs("button",{onClick:()=>{se(s.id),g(2)},className:`p-6 rounded-2xl border-2 flex flex-col items-center gap-3 transition-all hover:scale-[1.02] active:scale-95 ${n===s.id?`border-${s.color}-500 bg-${s.color}-50 text-${s.color}-900 shadow-md`:"border-slate-200 bg-white text-slate-600 hover:border-slate-300"}`,children:[e.jsx("div",{className:`p-3 rounded-full ${n===s.id?"bg-white":"bg-slate-100"}`,children:s.icon}),e.jsx("span",{className:"font-bold",children:s.label})]},s.id))}),e.jsxs("div",{className:"bg-purple-50 p-4 rounded-xl border border-purple-100 flex gap-3 items-start",children:[e.jsx(V,{className:"text-purple-600 shrink-0 mt-1",size:20}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-purple-900 text-sm",children:"AI Assisted Mode"}),e.jsx("p",{className:"text-xs text-purple-700 mt-1",children:"Take a photo in the next step, and our AI will automatically assess the severity and type of damage for you."})]})]})]}),m===2&&e.jsxs("div",{className:"space-y-6 animate-slide-up",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx("label",{className:"block text-sm font-bold text-slate-900 uppercase tracking-wider",children:"1. Visual Evidence"}),e.jsxs("div",{className:"border-2 border-slate-300 rounded-xl bg-black min-h-[240px] relative overflow-hidden shadow-sm",children:[e.jsx("canvas",{ref:y,className:"hidden"}),le&&e.jsx("div",{className:"absolute inset-0 bg-white z-50 transition-opacity duration-150 ease-out"}),h?e.jsxs("div",{className:"relative w-full h-full flex flex-col items-center justify-center bg-black group",children:[e.jsx("video",{ref:l,autoPlay:!0,playsInline:!0,muted:!0,onClick:E,className:"w-full h-full object-cover absolute inset-0 cursor-pointer"}),e.jsx("div",{className:"absolute bottom-4 left-0 right-0 flex justify-center z-10 pointer-events-none",children:e.jsx("button",{onClick:s=>{s.stopPropagation(),E()},className:"w-16 h-16 bg-white rounded-full border-4 border-slate-300 flex items-center justify-center hover:scale-105 active:scale-95 transition-transform shadow-lg pointer-events-auto",title:"Take Photo (Spacebar)",children:e.jsx("div",{className:"w-12 h-12 bg-red-600 rounded-full"})})}),e.jsx("div",{className:"absolute top-4 right-4 z-10 pointer-events-none",children:e.jsx("button",{onClick:s=>{s.stopPropagation(),C(),N(!1)},className:"bg-black/50 text-white p-2 rounded-full backdrop-blur pointer-events-auto hover:bg-black/70",children:e.jsx(xe,{size:20})})}),e.jsx("div",{className:"absolute top-4 left-4 z-10 pointer-events-none",children:e.jsxs("span",{className:"bg-black/50 text-white text-[10px] px-2 py-1 rounded backdrop-blur font-bold uppercase flex items-center gap-1",children:[e.jsx(me,{size:10,className:"hidden md:block"})," Click or Press Space"]})})]}):c?e.jsxs("div",{className:"relative w-full h-full",children:[e.jsx("img",{src:c,alt:"Damage Evidence",className:"w-full h-full object-cover"}),w&&e.jsxs("div",{className:"absolute inset-0 bg-black/60 flex flex-col items-center justify-center text-white backdrop-blur-sm",children:[e.jsx(q,{size:48,className:"animate-spin mb-3 text-brand-400"}),e.jsx("span",{className:"font-bold text-lg animate-pulse",children:"AI Analyzing Structure..."})]}),!w&&e.jsx("div",{className:"absolute bottom-4 right-4",children:e.jsxs(x,{size:"sm",onClick:ne,className:"bg-white text-slate-900 hover:bg-slate-100 font-bold shadow-lg",children:[e.jsx(Z,{size:16,className:"mr-2"})," Retake"]})})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center h-60 bg-slate-100 text-slate-400",children:[e.jsx(ue,{size:48,className:"mb-3 opacity-50"}),e.jsx("p",{className:"font-bold text-slate-600",children:"No Evidence Added"}),e.jsx("p",{className:"text-xs mb-4",children:"Photos help prioritize your claim"}),e.jsxs(x,{onClick:K,className:"font-bold bg-slate-800 text-white hover:bg-slate-700",children:[e.jsx(he,{size:18,className:"mr-2"})," Open Camera"]})]})]}),$&&!w&&e.jsxs("div",{className:"bg-indigo-50 border border-indigo-200 p-4 rounded-xl animate-slide-up shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2 text-indigo-700 font-bold text-xs uppercase tracking-wide",children:[e.jsx(V,{size:16})," Gemini AI Assessment"]}),e.jsxs("p",{className:"text-sm text-indigo-900 leading-relaxed font-medium",children:['"',$,'"']})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("label",{className:"block text-sm font-bold text-slate-900 uppercase tracking-wider",children:"2. Severity Level"}),e.jsx("div",{className:"flex gap-2",children:[{lvl:1,label:"Minor",color:"green"},{lvl:2,label:"Moderate",color:"yellow"},{lvl:3,label:"Severe",color:"red"}].map(s=>e.jsx("button",{onClick:()=>z(s.lvl),className:`flex-1 py-3 rounded-xl border-2 font-bold text-sm transition-all ${o===s.lvl?`bg-${s.color}-100 border-${s.color}-500 text-${s.color}-800 shadow-sm ring-1 ring-${s.color}-500`:"bg-white border-slate-200 text-slate-400 hover:border-slate-300"}`,children:s.label},s.lvl))})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("label",{className:"block text-sm font-bold text-slate-900 uppercase tracking-wider",children:"3. Details"}),e.jsx(Ne,{placeholder:"Add additional notes here...",value:D,onChange:s=>T(s.target.value),className:"min-h-[100px] border-slate-300 focus:border-brand-500"})]}),e.jsx(x,{fullWidth:!0,size:"lg",className:"shadow-lg mt-4 bg-brand-600 hover:bg-brand-700 font-bold",onClick:ie,disabled:G,children:G?"Submitting...":"Submit Assessment"}),H&&e.jsx("p",{className:"text-xs text-red-600 font-semibold mt-2",children:H})]}),m===3&&e.jsxs("div",{className:"flex flex-col items-center justify-center text-center space-y-6 animate-fade-in pt-10",children:[e.jsx("div",{className:"w-24 h-24 bg-green-100 rounded-full flex items-center justify-center text-green-600 mb-2 shadow-inner",children:e.jsx(be,{size:48})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-slate-900",children:"Report Filed"}),e.jsx("p",{className:"text-slate-600 font-medium",children:"Your damage assessment has been logged."})]}),e.jsxs("div",{className:"bg-white p-6 rounded-xl w-full text-left border border-slate-200 shadow-sm",children:[e.jsxs("div",{className:"flex justify-between mb-3 border-b border-slate-100 pb-2",children:[e.jsx("span",{className:"text-xs font-bold text-slate-500 uppercase",children:"Case ID"}),e.jsxs("span",{className:"text-xs font-mono font-bold text-slate-900",children:["DMG-",Math.floor(Math.random()*1e4)]})]}),(A||c)&&e.jsxs("div",{className:"mb-4",children:[e.jsx("p",{className:"text-xs font-bold text-slate-500 uppercase mb-2",children:"Photo Preview"}),e.jsx("img",{src:A||c||"",alt:"Submitted damage",className:"w-full max-h-56 object-cover rounded-lg border border-slate-200"}),A&&e.jsx("p",{className:"text-[10px] text-slate-500 mt-1",children:"Private link expires in 1 hour."})]}),e.jsxs("div",{className:"flex justify-between mb-3 border-b border-slate-100 pb-2",children:[e.jsx("span",{className:"text-xs font-bold text-slate-500 uppercase",children:"Type"}),e.jsx("span",{className:"text-sm font-bold text-slate-900",children:n})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-xs font-bold text-slate-500 uppercase",children:"Est. Severity"}),e.jsx("span",{className:`text-xs font-bold px-3 py-1 rounded-full uppercase ${o===3?"bg-red-100 text-red-700":o===2?"bg-yellow-100 text-yellow-700":"bg-green-100 text-green-700"}`,children:o===3?"Critical":o===2?"Moderate":"Minor"})]})]}),e.jsx(x,{fullWidth:!0,variant:"outline",onClick:()=>f("DASHBOARD"),className:"border-slate-300 text-slate-700 font-bold",children:"Return to Dashboard"})]})]})]})};export{Ie as AssessmentView};
