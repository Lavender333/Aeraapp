import{c as w,r as o,S as H,E as O,j as t}from"./index-DBXkWCLS.js";import{s as x}from"./supabaseClient-mPg3YQ39.js";import{A as Y}from"./arrow-left-cQpRBPyt.js";import{L as V}from"./loader-circle-DYVAH_oM.js";import{b as K,l as Z,a as Q,e as W,M as X,T as ee}from"./TileLayer-D_qsWxCk.js";import{U as te,A as se}from"./users-BQ_m5P8y.js";import{T as re}from"./triangle-alert-mL0WtJLm.js";import"./index-Cu0yPAYF.js";/**
 * @license lucide-react v0.556.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ae=[["path",{d:"M12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83z",key:"zw3jo"}],["path",{d:"M2 12a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 12",key:"1wduqc"}],["path",{d:"M2 17a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 17",key:"kqbvx6"}]],oe=w("layers",ae);/**
 * @license lucide-react v0.556.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ie=[["path",{d:"M3 5h.01",key:"18ugdj"}],["path",{d:"M3 12h.01",key:"nlz23k"}],["path",{d:"M3 19h.01",key:"noohij"}],["path",{d:"M8 5h13",key:"1pao27"}],["path",{d:"M8 12h13",key:"1za7za"}],["path",{d:"M8 19h13",key:"m83p4d"}]],ne=w("list",ie);/**
 * @license lucide-react v0.556.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const le=[["path",{d:"M14.106 5.553a2 2 0 0 0 1.788 0l3.659-1.83A1 1 0 0 1 21 4.619v12.764a1 1 0 0 1-.553.894l-4.553 2.277a2 2 0 0 1-1.788 0l-4.212-2.106a2 2 0 0 0-1.788 0l-3.659 1.83A1 1 0 0 1 3 19.381V6.618a1 1 0 0 1 .553-.894l4.553-2.277a2 2 0 0 1 1.788 0z",key:"169xi5"}],["path",{d:"M15 5.764v15",key:"1pn4in"}],["path",{d:"M9 3.236v15",key:"1uimfh"}]],de=w("map",le),ce=K(function({data:s,...d},u){const h=new Z.GeoJSON(s,d);return Q(h,W(u,{overlayContainer:h}))},function(s,d,u){d.style!==u.style&&(d.style==null?s.resetStyle():s.setStyle(d.style))});async function pe(){const{data:a,error:s}=await x.auth.getUser();if(s||!(a!=null&&a.user))throw new Error("Not authenticated");const{data:d,error:u}=await x.from("profiles").select("id, role, org_id, county_id, state_id").eq("id",a.user.id).single();if(u||!d)throw new Error("Unable to load user map scope");return d}async function ue(){const{data:a,error:s}=await x.from("geography_regions_map_view").select("id, organization_id, county_id, state_id, region_name, region_type, geojson, centroid_geojson, updated_at").order("region_name",{ascending:!0});if(s)throw s;return a||[]}async function me(){const{data:a,error:s}=await x.from("region_snapshot_latest_view").select("id, snapshot_date, organization_id, county_id, state_id, region_id, profile_count, avg_risk_score, max_risk_score, min_risk_score, risk_growth_pct, drift_value, drift_status, kmeans_cluster, dbscan_cluster, anomaly_count, projection_14d, model_version, pipeline_run_id, created_at").order("snapshot_date",{ascending:!1});if(s)throw s;return a||[]}async function xe(a=100){const s=new Date().toISOString(),{data:d,error:u}=await x.from("alerts").select("id, source, event_type, severity, headline, description, effective_at, expires_at, organization_id, county_id, state_id, region_id, created_at").or("expires_at.is.null,expires_at.gte.".concat(s)).order("created_at",{ascending:!1}).limit(a);if(u)throw u;return d||[]}async function he(){const{data:a,error:s}=await x.from("state_household_join_activity_view").select("state_id, county_id, pending_requests, approved_last_24h, rejected_last_24h, submitted_last_24h, last_activity_at").order("pending_requests",{ascending:!1}).limit(250);if(s)throw s;return a||[]}const ge=["ADMIN","STATE_ADMIN","COUNTY_ADMIN","LOCAL_AUTHORITY","FIRST_RESPONDER"],_e=["INSTITUTION_ADMIN","ORG_ADMIN"],z=a=>a==="ACCELERATING"?"#ef4444":a==="ESCALATING"?"#f59e0b":"#22c55e",Me=({setView:a})=>{const[s,d]=o.useState("MAP"),[u,h]=o.useState(!0),[A,M]=o.useState(null),[k,D]=o.useState([]),[_,G]=o.useState([]),[N,$]=o.useState([]),[b,P]=o.useState([]),[n,U]=o.useState(null),J=o.useMemo(()=>H.getProfile(),[]),c=(n==null?void 0:n.role)||J.role||"GENERAL_USER",S=ge.includes(c),E=_e.includes(c),m=o.useCallback(async()=>{h(!0),M(null);try{const[e,l,i,r,p]=await Promise.all([pe(),ue(),me(),xe(100),he()]);U(e),D(l),G(i),$(r),P(p)}catch(e){M((e==null?void 0:e.message)||"Unable to load map layers.")}finally{h(!1)}},[]);o.useEffect(()=>{m()},[m]),o.useEffect(()=>{const e=O.channel("population-map-realtime").on("postgres_changes",{event:"*",schema:"public",table:"region_snapshots"},()=>{m()}).on("postgres_changes",{event:"*",schema:"public",table:"alerts"},()=>{m()}).on("postgres_changes",{event:"*",schema:"public",table:"geography_regions"},()=>{m()}).on("postgres_changes",{event:"*",schema:"public",table:"household_join_requests"},()=>{m()}).subscribe();return()=>{O.removeChannel(e)}},[m]);const g=o.useMemo(()=>S?_:c==="COUNTY_ADMIN"&&(n!=null&&n.county_id)?_.filter(e=>e.county_id===n.county_id):E&&(n!=null&&n.org_id)?_.filter(e=>e.organization_id===n.org_id):[],[S,E,c,n==null?void 0:n.county_id,n==null?void 0:n.org_id,_]),v=o.useMemo(()=>{const e=new Map;for(const l of g){const i="".concat(l.state_id,"::").concat(l.county_id);e.has(i)||e.set(i,l)}return e},[g]),R=o.useMemo(()=>({type:"FeatureCollection",features:k.filter(e=>!!e.geojson).map(e=>({type:"Feature",geometry:e.geojson,properties:{id:e.id,region_name:e.region_name,region_type:e.region_type,county_id:e.county_id,state_id:e.state_id}}))}),[k]),q=o.useCallback(e=>{var f,y;const l="".concat(((f=e==null?void 0:e.properties)==null?void 0:f.state_id)||"","::").concat(((y=e==null?void 0:e.properties)==null?void 0:y.county_id)||""),i=v.get(l),r=z(i==null?void 0:i.drift_status),p=(i==null?void 0:i.drift_status)==="ACCELERATING"?.45:(i==null?void 0:i.drift_status)==="ESCALATING"?.35:.2;return{color:r,weight:2,fillColor:r,fillOpacity:p}},[v]),F=o.useMemo(()=>c==="STATE_ADMIN"||c==="ADMIN"?"State-wide aggregate risk overlays enabled":c==="COUNTY_ADMIN"?"County aggregate overlays enabled":c==="ORG_ADMIN"||c==="INSTITUTION_ADMIN"?"Organization-scoped overlays enabled":c==="MEMBER"||c==="GENERAL_USER"?"Member view: alerts and limited area status":"Role-based map visibility applied",[c]),C=o.useMemo(()=>[...g].sort((e,l)=>Number(l.avg_risk_score||0)-Number(e.avg_risk_score||0)).slice(0,20),[g]),j=o.useMemo(()=>{const e=b.reduce((r,p)=>r+Number(p.pending_requests||0),0),l=b.reduce((r,p)=>r+Number(p.approved_last_24h||0),0),i=b.reduce((r,p)=>r+Number(p.submitted_last_24h||0),0);return{pending:e,approved24h:l,submitted24h:i}},[b]);return t.jsxs("div",{className:"min-h-screen bg-slate-50 flex flex-col pb-safe animate-fade-in",children:[t.jsxs("div",{className:"bg-white border-b border-slate-200 p-4 sticky top-0 z-20 shadow-sm",children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("button",{onClick:()=>a("DASHBOARD"),className:"p-2 -ml-2 text-slate-500 hover:text-slate-800",children:t.jsx(Y,{size:24})}),t.jsxs("div",{children:[t.jsx("h1",{className:"font-bold text-lg text-slate-900",children:"Population Tracker"}),t.jsx("p",{className:"text-[11px] text-slate-500",children:F})]})]}),t.jsxs("div",{className:"flex bg-slate-100 rounded-lg p-1",children:[t.jsx("button",{onClick:()=>d("MAP"),className:"p-2 rounded ".concat(s==="MAP"?"bg-white shadow text-slate-900":"text-slate-500"),children:t.jsx(de,{size:18})}),t.jsx("button",{onClick:()=>d("LIST"),className:"p-2 rounded ".concat(s==="LIST"?"bg-white shadow text-slate-900":"text-slate-500"),children:t.jsx(ne,{size:18})})]})]}),t.jsxs("div",{className:"flex gap-2 overflow-x-auto pb-2 no-scrollbar",children:[t.jsx("span",{className:"px-3 py-1 bg-slate-800 text-white rounded-full text-xs font-medium whitespace-nowrap",children:"All Zones"}),t.jsx("span",{className:"px-3 py-1 bg-red-50 border border-red-200 text-red-700 rounded-full text-xs font-medium whitespace-nowrap",children:"Accelerating"}),t.jsx("span",{className:"px-3 py-1 bg-amber-50 border border-amber-200 text-amber-700 rounded-full text-xs font-medium whitespace-nowrap",children:"Escalating"}),t.jsx("span",{className:"px-3 py-1 bg-green-50 border border-green-200 text-green-700 rounded-full text-xs font-medium whitespace-nowrap",children:"Stable"}),t.jsxs("span",{className:"px-3 py-1 bg-blue-50 border border-blue-200 text-blue-700 rounded-full text-xs font-medium whitespace-nowrap",children:["Active Alerts: ",N.length]}),t.jsxs("span",{className:"px-3 py-1 bg-indigo-50 border border-indigo-200 text-indigo-700 rounded-full text-xs font-medium whitespace-nowrap",children:["Join Requests Pending: ",j.pending]}),t.jsxs("span",{className:"px-3 py-1 bg-emerald-50 border border-emerald-200 text-emerald-700 rounded-full text-xs font-medium whitespace-nowrap",children:["Join Approvals 24h: ",j.approved24h]})]})]}),u?t.jsxs("div",{className:"flex-1 flex items-center justify-center text-slate-600",children:[t.jsx(V,{size:18,className:"animate-spin mr-2"})," Loading map layers..."]}):A?t.jsx("div",{className:"m-4 p-4 rounded-xl border border-red-200 bg-red-50 text-red-700 text-sm",children:A}):t.jsx("div",{className:"flex-1 relative",children:s==="MAP"?t.jsxs("div",{className:"absolute inset-0",children:[t.jsxs(X,{center:[39.5,-98.35],zoom:4,style:{height:"100%",width:"100%"},children:[t.jsx(ee,{attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"}),R.features.length>0&&t.jsx(ce,{data:R,style:q,onEachFeature:(e,l)=>{var T,I,L;const i="".concat(((T=e==null?void 0:e.properties)==null?void 0:T.state_id)||"","::").concat(((I=e==null?void 0:e.properties)==null?void 0:I.county_id)||""),r=v.get(i),p=((L=e==null?void 0:e.properties)==null?void 0:L.region_name)||"Region",f=(r==null?void 0:r.drift_status)||"STABLE",y=Number((r==null?void 0:r.avg_risk_score)||0).toFixed(2),B=Number((r==null?void 0:r.risk_growth_pct)||0)*100;l.bindPopup("<strong>".concat(p,"</strong><br/>Drift: ").concat(f,"<br/>Avg Risk: ").concat(y,"<br/>Growth: ").concat(B.toFixed(1),"%"))}})]}),t.jsx("div",{className:"absolute bottom-4 left-4 right-4 bg-white/95 backdrop-blur p-4 rounded-xl shadow-lg border border-slate-200",children:t.jsxs("div",{className:"flex justify-between items-end gap-3",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-xs font-bold text-slate-500 uppercase",children:"Map Summary"}),t.jsxs("p",{className:"text-base font-bold text-slate-900",children:[g.length," region snapshot(s)"]}),t.jsxs("p",{className:"text-sm text-slate-600",children:[N.length," active alert(s) • ",j.submitted24h," join submissions in 24h • realtime enabled"]})]}),t.jsx(oe,{className:"text-slate-400"})]})})]}):t.jsxs("div",{className:"p-4 space-y-3 overflow-y-auto max-h-[calc(100vh-180px)]",children:[C.length===0?t.jsx("div",{className:"bg-white p-4 rounded-xl border border-slate-200 text-sm text-slate-500",children:"No aggregate rows available for your role scope."}):C.map(e=>{const l=z(e.drift_status);return t.jsxs("div",{className:"bg-white p-4 rounded-xl border border-slate-200 flex justify-between items-center gap-3",children:[t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx("div",{className:"w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-500",children:t.jsx(te,{size:20})}),t.jsxs("div",{children:[t.jsxs("p",{className:"font-bold text-slate-900",children:[e.county_id,", ",e.state_id]}),t.jsxs("p",{className:"text-xs text-slate-500",children:["Avg Risk ",Number(e.avg_risk_score||0).toFixed(2)," • Profiles ",e.profile_count]}),t.jsxs("p",{className:"text-xs text-slate-500 flex items-center gap-1",children:[t.jsx(se,{size:12})," Growth ",(Number(e.risk_growth_pct||0)*100).toFixed(1),"%"]})]})]}),t.jsx("span",{className:"px-2 py-1 rounded text-xs font-bold text-white",style:{backgroundColor:l},children:e.drift_status})]},e.id)}),N.slice(0,10).map(e=>t.jsxs("div",{className:"bg-amber-50 p-3 rounded-xl border border-amber-200 flex items-start gap-2",children:[t.jsx(re,{size:16,className:"text-amber-700 mt-0.5"}),t.jsxs("div",{children:[t.jsxs("p",{className:"text-xs font-bold text-amber-800 uppercase",children:[e.severity," • ",e.source]}),t.jsx("p",{className:"text-sm text-amber-900 font-semibold",children:e.headline})]})]},e.id))]})})]})};export{Me as PopulationView};
