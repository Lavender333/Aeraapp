import{a as r,j as t,G as F,at as J,au as Z,ak as B,J as V,K as Y,av as W,aw as X,U as H,A as K,l as q}from"./vendor-react-DZ0IVLBb.js";import"./vendor-maps-S3fC-LOA.js";import{S as Q,m as k}from"./index-D_urGLpe.js";import{c as ee}from"./vendor-supabase-ChvUvA8t.js";import"./vendor-CCVjAPEY.js";import"./vendor-jspdf-Bd23t5aa.js";const te="https://zghyxeieetqubodgplgo.supabase.co",se="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpnaHl4ZWllZXRxdWJvZGdwbGdvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1MDkwNzcsImV4cCI6MjA4NjA4NTA3N30.4ML7Ce1VsVQfhbmuChWk6_tRdx_doRWIzxC9nS873B8",m=ee(te,se,{auth:{persistSession:!0,autoRefreshToken:!0}});async function re(){const{data:i,error:n}=await m.auth.getUser();if(n||!(i!=null&&i.user))throw new Error("Not authenticated");const{data:d,error:p}=await m.from("profiles").select("id, role, org_id, county_id, state_id").eq("id",i.user.id).single();if(p||!d)throw new Error("Unable to load user map scope");return d}async function ae(){const{data:i,error:n}=await m.from("geography_regions_map_view").select("id, organization_id, county_id, state_id, region_name, region_type, geojson, centroid_geojson, updated_at").order("region_name",{ascending:!0});if(n)throw n;return i||[]}async function ie(){const{data:i,error:n}=await m.from("region_snapshot_latest_view").select("id, snapshot_date, organization_id, county_id, state_id, region_id, profile_count, avg_risk_score, max_risk_score, min_risk_score, risk_growth_pct, drift_value, drift_status, kmeans_cluster, dbscan_cluster, anomaly_count, projection_14d, model_version, pipeline_run_id, created_at").order("snapshot_date",{ascending:!1});if(n)throw n;return i||[]}async function oe(i=100){const n=new Date().toISOString(),{data:d,error:p}=await m.from("alerts").select("id, source, event_type, severity, headline, description, effective_at, expires_at, organization_id, county_id, state_id, region_id, created_at").or(`expires_at.is.null,expires_at.gte.${n}`).order("created_at",{ascending:!1}).limit(i);if(p)throw p;return d||[]}const ne=["ADMIN","STATE_ADMIN","COUNTY_ADMIN","LOCAL_AUTHORITY","FIRST_RESPONDER"],le=["INSTITUTION_ADMIN","ORG_ADMIN"],T=i=>i==="ACCELERATING"?"#ef4444":i==="ESCALATING"?"#f59e0b":"#22c55e",ge=({setView:i})=>{const[n,d]=r.useState("MAP"),[p,y]=r.useState(!0),[j,w]=r.useState(null),[v,L]=r.useState([]),[g,O]=r.useState([]),[h,z]=r.useState([]),[s,D]=r.useState(null),G=r.useMemo(()=>Q.getProfile(),[]),c=(s==null?void 0:s.role)||G.role||"GENERAL_USER",A=ne.includes(c),I=le.includes(c),x=r.useCallback(async()=>{y(!0),w(null);try{const[e,l,a,o]=await Promise.all([re(),ae(),ie(),oe(100)]);D(e),L(l),O(a),z(o)}catch(e){w((e==null?void 0:e.message)||"Unable to load map layers.")}finally{y(!1)}},[]);r.useEffect(()=>{x()},[x]),r.useEffect(()=>{const e=k.channel("population-map-realtime").on("postgres_changes",{event:"*",schema:"public",table:"region_snapshots"},()=>{x()}).on("postgres_changes",{event:"*",schema:"public",table:"alerts"},()=>{x()}).on("postgres_changes",{event:"*",schema:"public",table:"geography_regions"},()=>{x()}).subscribe();return()=>{k.removeChannel(e)}},[x]);const u=r.useMemo(()=>A?g:c==="COUNTY_ADMIN"&&(s!=null&&s.county_id)?g.filter(e=>e.county_id===s.county_id):I&&(s!=null&&s.org_id)?g.filter(e=>e.organization_id===s.org_id):[],[A,I,c,s==null?void 0:s.county_id,s==null?void 0:s.org_id,g]),f=r.useMemo(()=>{const e=new Map;for(const l of u){const a=`${l.state_id}::${l.county_id}`;e.has(a)||e.set(a,l)}return e},[u]),M=r.useMemo(()=>({type:"FeatureCollection",features:v.filter(e=>!!e.geojson).map(e=>({type:"Feature",geometry:e.geojson,properties:{id:e.id,region_name:e.region_name,region_type:e.region_type,county_id:e.county_id,state_id:e.state_id}}))}),[v]),U=r.useCallback(e=>{var _,b;const l=`${((_=e==null?void 0:e.properties)==null?void 0:_.state_id)||""}::${((b=e==null?void 0:e.properties)==null?void 0:b.county_id)||""}`,a=f.get(l),o=T(a==null?void 0:a.drift_status),N=(a==null?void 0:a.drift_status)==="ACCELERATING"?.45:(a==null?void 0:a.drift_status)==="ESCALATING"?.35:.2;return{color:o,weight:2,fillColor:o,fillOpacity:N}},[f]),$=r.useMemo(()=>c==="STATE_ADMIN"||c==="ADMIN"?"State-wide aggregate risk overlays enabled":c==="COUNTY_ADMIN"?"County aggregate overlays enabled":c==="ORG_ADMIN"||c==="INSTITUTION_ADMIN"?"Organization-scoped overlays enabled":c==="MEMBER"||c==="GENERAL_USER"?"Member view: alerts and limited area status":"Role-based map visibility applied",[c]),R=r.useMemo(()=>[...u].sort((e,l)=>Number(l.avg_risk_score||0)-Number(e.avg_risk_score||0)).slice(0,20),[u]);return t.jsxs("div",{className:"min-h-screen bg-slate-50 flex flex-col pb-safe animate-fade-in",children:[t.jsxs("div",{className:"bg-white border-b border-slate-200 p-4 sticky top-0 z-20 shadow-sm",children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("button",{onClick:()=>i("DASHBOARD"),className:"p-2 -ml-2 text-slate-500 hover:text-slate-800",children:t.jsx(F,{size:24})}),t.jsxs("div",{children:[t.jsx("h1",{className:"font-bold text-lg text-slate-900",children:"Population Tracker"}),t.jsx("p",{className:"text-[11px] text-slate-500",children:$})]})]}),t.jsxs("div",{className:"flex bg-slate-100 rounded-lg p-1",children:[t.jsx("button",{onClick:()=>d("MAP"),className:`p-2 rounded ${n==="MAP"?"bg-white shadow text-slate-900":"text-slate-500"}`,children:t.jsx(J,{size:18})}),t.jsx("button",{onClick:()=>d("LIST"),className:`p-2 rounded ${n==="LIST"?"bg-white shadow text-slate-900":"text-slate-500"}`,children:t.jsx(Z,{size:18})})]})]}),t.jsxs("div",{className:"flex gap-2 overflow-x-auto pb-2 no-scrollbar",children:[t.jsx("span",{className:"px-3 py-1 bg-slate-800 text-white rounded-full text-xs font-medium whitespace-nowrap",children:"All Zones"}),t.jsx("span",{className:"px-3 py-1 bg-red-50 border border-red-200 text-red-700 rounded-full text-xs font-medium whitespace-nowrap",children:"Accelerating"}),t.jsx("span",{className:"px-3 py-1 bg-amber-50 border border-amber-200 text-amber-700 rounded-full text-xs font-medium whitespace-nowrap",children:"Escalating"}),t.jsx("span",{className:"px-3 py-1 bg-green-50 border border-green-200 text-green-700 rounded-full text-xs font-medium whitespace-nowrap",children:"Stable"}),t.jsxs("span",{className:"px-3 py-1 bg-blue-50 border border-blue-200 text-blue-700 rounded-full text-xs font-medium whitespace-nowrap",children:["Active Alerts: ",h.length]})]})]}),p?t.jsxs("div",{className:"flex-1 flex items-center justify-center text-slate-600",children:[t.jsx(B,{size:18,className:"animate-spin mr-2"})," Loading map layers..."]}):j?t.jsx("div",{className:"m-4 p-4 rounded-xl border border-red-200 bg-red-50 text-red-700 text-sm",children:j}):t.jsx("div",{className:"flex-1 relative",children:n==="MAP"?t.jsxs("div",{className:"absolute inset-0",children:[t.jsxs(V,{center:[39.5,-98.35],zoom:4,style:{height:"100%",width:"100%"},children:[t.jsx(Y,{attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"}),M.features.length>0&&t.jsx(W,{data:M,style:U,onEachFeature:(e,l)=>{var S,E,C;const a=`${((S=e==null?void 0:e.properties)==null?void 0:S.state_id)||""}::${((E=e==null?void 0:e.properties)==null?void 0:E.county_id)||""}`,o=f.get(a),N=((C=e==null?void 0:e.properties)==null?void 0:C.region_name)||"Region",_=(o==null?void 0:o.drift_status)||"STABLE",b=Number((o==null?void 0:o.avg_risk_score)||0).toFixed(2),P=Number((o==null?void 0:o.risk_growth_pct)||0)*100;l.bindPopup(`<strong>${N}</strong><br/>Drift: ${_}<br/>Avg Risk: ${b}<br/>Growth: ${P.toFixed(1)}%`)}})]}),t.jsx("div",{className:"absolute bottom-4 left-4 right-4 bg-white/95 backdrop-blur p-4 rounded-xl shadow-lg border border-slate-200",children:t.jsxs("div",{className:"flex justify-between items-end gap-3",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-xs font-bold text-slate-500 uppercase",children:"Map Summary"}),t.jsxs("p",{className:"text-base font-bold text-slate-900",children:[u.length," region snapshot(s)"]}),t.jsxs("p",{className:"text-sm text-slate-600",children:[h.length," active alert(s) • realtime enabled"]})]}),t.jsx(X,{className:"text-slate-400"})]})})]}):t.jsxs("div",{className:"p-4 space-y-3 overflow-y-auto max-h-[calc(100vh-180px)]",children:[R.length===0?t.jsx("div",{className:"bg-white p-4 rounded-xl border border-slate-200 text-sm text-slate-500",children:"No aggregate rows available for your role scope."}):R.map(e=>{const l=T(e.drift_status);return t.jsxs("div",{className:"bg-white p-4 rounded-xl border border-slate-200 flex justify-between items-center gap-3",children:[t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx("div",{className:"w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-500",children:t.jsx(H,{size:20})}),t.jsxs("div",{children:[t.jsxs("p",{className:"font-bold text-slate-900",children:[e.county_id,", ",e.state_id]}),t.jsxs("p",{className:"text-xs text-slate-500",children:["Avg Risk ",Number(e.avg_risk_score||0).toFixed(2)," • Profiles ",e.profile_count]}),t.jsxs("p",{className:"text-xs text-slate-500 flex items-center gap-1",children:[t.jsx(K,{size:12})," Growth ",(Number(e.risk_growth_pct||0)*100).toFixed(1),"%"]})]})]}),t.jsx("span",{className:"px-2 py-1 rounded text-xs font-bold text-white",style:{backgroundColor:l},children:e.drift_status})]},e.id)}),h.slice(0,10).map(e=>t.jsxs("div",{className:"bg-amber-50 p-3 rounded-xl border border-amber-200 flex items-start gap-2",children:[t.jsx(q,{size:16,className:"text-amber-700 mt-0.5"}),t.jsxs("div",{children:[t.jsxs("p",{className:"text-xs font-bold text-amber-800 uppercase",children:[e.severity," • ",e.source]}),t.jsx("p",{className:"text-sm text-amber-900 font-semibold",children:e.headline})]})]},e.id))]})})]})};export{ge as PopulationView};
