System.register(["./index-legacy-CBJaRI7y.js","./supabaseClient-legacy-C8OzX_Zs.js","./arrow-left-legacy-BCEH-quZ.js","./loader-circle-legacy-D8bpLPmH.js","./TileLayer-legacy-otnLbpi3.js","./users-legacy-B4iQSQp3.js","./triangle-alert-legacy-DyH4Tz7g.js","./index-legacy-DfIheBmm.js"],function(e,t){"use strict";var s,a,r,i,l,n,o,d,c,u,p,x,m,h,g,_,b;return{setters:[e=>{s=e.c,a=e.r,r=e.S,i=e.E,l=e.j},e=>{n=e.s},e=>{o=e.A},e=>{d=e.L},e=>{c=e.b,u=e.l,p=e.a,x=e.e,m=e.M,h=e.T},e=>{g=e.U,_=e.A},e=>{b=e.T},null],execute:function(){
/**
       * @license lucide-react v0.556.0 - ISC
       *
       * This source code is licensed under the ISC license.
       * See the LICENSE file in the root directory of this source tree.
       */
const t=s("layers",[["path",{d:"M12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83z",key:"zw3jo"}],["path",{d:"M2 12a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 12",key:"1wduqc"}],["path",{d:"M2 17a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 17",key:"kqbvx6"}]]),f=s("list",[["path",{d:"M3 5h.01",key:"18ugdj"}],["path",{d:"M3 12h.01",key:"nlz23k"}],["path",{d:"M3 19h.01",key:"noohij"}],["path",{d:"M8 5h13",key:"1pao27"}],["path",{d:"M8 12h13",key:"1za7za"}],["path",{d:"M8 19h13",key:"m83p4d"}]]),y=s("map",[["path",{d:"M14.106 5.553a2 2 0 0 0 1.788 0l3.659-1.83A1 1 0 0 1 21 4.619v12.764a1 1 0 0 1-.553.894l-4.553 2.277a2 2 0 0 1-1.788 0l-4.212-2.106a2 2 0 0 0-1.788 0l-3.659 1.83A1 1 0 0 1 3 19.381V6.618a1 1 0 0 1 .553-.894l4.553-2.277a2 2 0 0 1 1.788 0z",key:"169xi5"}],["path",{d:"M15 5.764v15",key:"1pn4in"}],["path",{d:"M9 3.236v15",key:"1uimfh"}]]),v=c(function({data:e,...t},s){const a=new u.GeoJSON(e,t);return p(a,x(s,{overlayContainer:a}))},function(e,t,s){t.style!==s.style&&(null==t.style?e.resetStyle():e.setStyle(t.style))});async function j(){const{data:e,error:t}=await n.auth.getUser();if(t||null==e||!e.user)throw new Error("Not authenticated");const{data:s,error:a}=await n.from("profiles").select("id, role, org_id, county_id, state_id").eq("id",e.user.id).single();if(a||!s)throw new Error("Unable to load user map scope");return s}async function N(){const{data:e,error:t}=await n.from("geography_regions_map_view").select("id, organization_id, county_id, state_id, region_name, region_type, geojson, centroid_geojson, updated_at").order("region_name",{ascending:!0});if(t)throw t;return e||[]}async function w(){const{data:e,error:t}=await n.from("region_snapshot_latest_view").select("id, snapshot_date, organization_id, county_id, state_id, region_id, profile_count, avg_risk_score, max_risk_score, min_risk_score, risk_growth_pct, drift_value, drift_status, kmeans_cluster, dbscan_cluster, anomaly_count, projection_14d, model_version, pipeline_run_id, created_at").order("snapshot_date",{ascending:!1});if(t)throw t;return e||[]}async function A(e=100){const t=(new Date).toISOString(),{data:s,error:a}=await n.from("alerts").select("id, source, event_type, severity, headline, description, effective_at, expires_at, organization_id, county_id, state_id, region_id, created_at").or(`expires_at.is.null,expires_at.gte.${t}`).order("created_at",{ascending:!1}).limit(e);if(a)throw a;return s||[]}async function M(){const{data:e,error:t}=await n.from("state_household_join_activity_view").select("state_id, county_id, pending_requests, approved_last_24h, rejected_last_24h, submitted_last_24h, last_activity_at").order("pending_requests",{ascending:!1}).limit(250);if(t)throw t;return e||[]}const k=["ADMIN","STATE_ADMIN","COUNTY_ADMIN","LOCAL_AUTHORITY","FIRST_RESPONDER"],S=["INSTITUTION_ADMIN","ORG_ADMIN"],T=e=>"ACCELERATING"===e?"#ef4444":"ESCALATING"===e?"#f59e0b":"#22c55e";e("PopulationView",({setView:e})=>{const[s,n]=a.useState("MAP"),[c,u]=a.useState(!0),[p,x]=a.useState(null),[E,I]=a.useState([]),[C,z]=a.useState([]),[R,D]=a.useState([]),[O,L]=a.useState([]),[P,U]=a.useState(null),G=a.useMemo(()=>r.getProfile(),[]),$=(null==P?void 0:P.role)||G.role||"GENERAL_USER",q=k.includes($),F=S.includes($),B=a.useCallback(async()=>{u(!0),x(null);try{const[e,t,s,a,r]=await Promise.all([j(),N(),w(),A(100),M()]);U(e),I(t),z(s),D(a),L(r)}catch(e){x((null==e?void 0:e.message)||"Unable to load map layers.")}finally{u(!1)}},[]);a.useEffect(()=>{B()},[B]),a.useEffect(()=>{const e=i.channel("population-map-realtime").on("postgres_changes",{event:"*",schema:"public",table:"region_snapshots"},()=>{B()}).on("postgres_changes",{event:"*",schema:"public",table:"alerts"},()=>{B()}).on("postgres_changes",{event:"*",schema:"public",table:"geography_regions"},()=>{B()}).on("postgres_changes",{event:"*",schema:"public",table:"household_join_requests"},()=>{B()}).subscribe();return()=>{i.removeChannel(e)}},[B]);const J=a.useMemo(()=>q?C:"COUNTY_ADMIN"===$&&null!=P&&P.county_id?C.filter(e=>e.county_id===P.county_id):F&&null!=P&&P.org_id?C.filter(e=>e.organization_id===P.org_id):[],[q,F,$,null==P?void 0:P.county_id,null==P?void 0:P.org_id,C]),Y=a.useMemo(()=>{const e=new Map;for(const t of J){const s=`${t.state_id}::${t.county_id}`;e.has(s)||e.set(s,t)}return e},[J]),V=a.useMemo(()=>({type:"FeatureCollection",features:E.filter(e=>!!e.geojson).map(e=>({type:"Feature",geometry:e.geojson,properties:{id:e.id,region_name:e.region_name,region_type:e.region_type,county_id:e.county_id,state_id:e.state_id}}))}),[E]),H=a.useCallback(e=>{var t,s;const a=`${(null==e||null===(t=e.properties)||void 0===t?void 0:t.state_id)||""}::${(null==e||null===(s=e.properties)||void 0===s?void 0:s.county_id)||""}`,r=Y.get(a),i=T(null==r?void 0:r.drift_status);return{color:i,weight:2,fillColor:i,fillOpacity:"ACCELERATING"===(null==r?void 0:r.drift_status)?.45:"ESCALATING"===(null==r?void 0:r.drift_status)?.35:.2}},[Y]),Z=a.useMemo(()=>"STATE_ADMIN"===$||"ADMIN"===$?"State-wide aggregate risk overlays enabled":"COUNTY_ADMIN"===$?"County aggregate overlays enabled":"ORG_ADMIN"===$||"INSTITUTION_ADMIN"===$?"Organization-scoped overlays enabled":"MEMBER"===$||"GENERAL_USER"===$?"Member view: alerts and limited area status":"Role-based map visibility applied",[$]),K=a.useMemo(()=>[...J].sort((e,t)=>Number(t.avg_risk_score||0)-Number(e.avg_risk_score||0)).slice(0,20),[J]),Q=a.useMemo(()=>({pending:O.reduce((e,t)=>e+Number(t.pending_requests||0),0),approved24h:O.reduce((e,t)=>e+Number(t.approved_last_24h||0),0),submitted24h:O.reduce((e,t)=>e+Number(t.submitted_last_24h||0),0)}),[O]);return l.jsxs("div",{className:"min-h-screen bg-slate-50 flex flex-col pb-safe animate-fade-in",children:[l.jsxs("div",{className:"bg-white border-b border-slate-200 p-4 sticky top-0 z-20 shadow-sm",children:[l.jsxs("div",{className:"flex items-center justify-between mb-4",children:[l.jsxs("div",{className:"flex items-center gap-3",children:[l.jsx("button",{onClick:()=>e("DASHBOARD"),className:"p-2 -ml-2 text-slate-500 hover:text-slate-800",children:l.jsx(o,{size:24})}),l.jsxs("div",{children:[l.jsx("h1",{className:"font-bold text-lg text-slate-900",children:"Population Tracker"}),l.jsx("p",{className:"text-[11px] text-slate-500",children:Z})]})]}),l.jsxs("div",{className:"flex bg-slate-100 rounded-lg p-1",children:[l.jsx("button",{onClick:()=>n("MAP"),className:"p-2 rounded "+("MAP"===s?"bg-white shadow text-slate-900":"text-slate-500"),children:l.jsx(y,{size:18})}),l.jsx("button",{onClick:()=>n("LIST"),className:"p-2 rounded "+("LIST"===s?"bg-white shadow text-slate-900":"text-slate-500"),children:l.jsx(f,{size:18})})]})]}),l.jsxs("div",{className:"flex gap-2 overflow-x-auto pb-2 no-scrollbar",children:[l.jsx("span",{className:"px-3 py-1 bg-slate-800 text-white rounded-full text-xs font-medium whitespace-nowrap",children:"All Zones"}),l.jsx("span",{className:"px-3 py-1 bg-red-50 border border-red-200 text-red-700 rounded-full text-xs font-medium whitespace-nowrap",children:"Accelerating"}),l.jsx("span",{className:"px-3 py-1 bg-amber-50 border border-amber-200 text-amber-700 rounded-full text-xs font-medium whitespace-nowrap",children:"Escalating"}),l.jsx("span",{className:"px-3 py-1 bg-green-50 border border-green-200 text-green-700 rounded-full text-xs font-medium whitespace-nowrap",children:"Stable"}),l.jsxs("span",{className:"px-3 py-1 bg-blue-50 border border-blue-200 text-blue-700 rounded-full text-xs font-medium whitespace-nowrap",children:["Active Alerts: ",R.length]}),l.jsxs("span",{className:"px-3 py-1 bg-indigo-50 border border-indigo-200 text-indigo-700 rounded-full text-xs font-medium whitespace-nowrap",children:["Join Requests Pending: ",Q.pending]}),l.jsxs("span",{className:"px-3 py-1 bg-emerald-50 border border-emerald-200 text-emerald-700 rounded-full text-xs font-medium whitespace-nowrap",children:["Join Approvals 24h: ",Q.approved24h]})]})]}),c?l.jsxs("div",{className:"flex-1 flex items-center justify-center text-slate-600",children:[l.jsx(d,{size:18,className:"animate-spin mr-2"})," Loading map layers..."]}):p?l.jsx("div",{className:"m-4 p-4 rounded-xl border border-red-200 bg-red-50 text-red-700 text-sm",children:p}):l.jsx("div",{className:"flex-1 relative",children:"MAP"===s?l.jsxs("div",{className:"absolute inset-0",children:[l.jsxs(m,{center:[39.5,-98.35],zoom:4,style:{height:"100%",width:"100%"},children:[l.jsx(h,{attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"}),V.features.length>0&&l.jsx(v,{data:V,style:H,onEachFeature:(e,t)=>{var s,a,r;const i=`${(null==e||null===(s=e.properties)||void 0===s?void 0:s.state_id)||""}::${(null==e||null===(a=e.properties)||void 0===a?void 0:a.county_id)||""}`,l=Y.get(i),n=(null==e||null===(r=e.properties)||void 0===r?void 0:r.region_name)||"Region",o=(null==l?void 0:l.drift_status)||"STABLE",d=Number((null==l?void 0:l.avg_risk_score)||0).toFixed(2),c=100*Number((null==l?void 0:l.risk_growth_pct)||0);t.bindPopup(`<strong>${n}</strong><br/>Drift: ${o}<br/>Avg Risk: ${d}<br/>Growth: ${c.toFixed(1)}%`)}})]}),l.jsx("div",{className:"absolute bottom-4 left-4 right-4 bg-white/95 backdrop-blur p-4 rounded-xl shadow-lg border border-slate-200",children:l.jsxs("div",{className:"flex justify-between items-end gap-3",children:[l.jsxs("div",{children:[l.jsx("p",{className:"text-xs font-bold text-slate-500 uppercase",children:"Map Summary"}),l.jsxs("p",{className:"text-base font-bold text-slate-900",children:[J.length," region snapshot(s)"]}),l.jsxs("p",{className:"text-sm text-slate-600",children:[R.length," active alert(s) • ",Q.submitted24h," join submissions in 24h • realtime enabled"]})]}),l.jsx(t,{className:"text-slate-400"})]})})]}):l.jsxs("div",{className:"p-4 space-y-3 overflow-y-auto max-h-[calc(100vh-180px)]",children:[0===K.length?l.jsx("div",{className:"bg-white p-4 rounded-xl border border-slate-200 text-sm text-slate-500",children:"No aggregate rows available for your role scope."}):K.map(e=>{const t=T(e.drift_status);return l.jsxs("div",{className:"bg-white p-4 rounded-xl border border-slate-200 flex justify-between items-center gap-3",children:[l.jsxs("div",{className:"flex items-start gap-3",children:[l.jsx("div",{className:"w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-500",children:l.jsx(g,{size:20})}),l.jsxs("div",{children:[l.jsxs("p",{className:"font-bold text-slate-900",children:[e.county_id,", ",e.state_id]}),l.jsxs("p",{className:"text-xs text-slate-500",children:["Avg Risk ",Number(e.avg_risk_score||0).toFixed(2)," • Profiles ",e.profile_count]}),l.jsxs("p",{className:"text-xs text-slate-500 flex items-center gap-1",children:[l.jsx(_,{size:12})," Growth ",(100*Number(e.risk_growth_pct||0)).toFixed(1),"%"]})]})]}),l.jsx("span",{className:"px-2 py-1 rounded text-xs font-bold text-white",style:{backgroundColor:t},children:e.drift_status})]},e.id)}),R.slice(0,10).map(e=>l.jsxs("div",{className:"bg-amber-50 p-3 rounded-xl border border-amber-200 flex items-start gap-2",children:[l.jsx(b,{size:16,className:"text-amber-700 mt-0.5"}),l.jsxs("div",{children:[l.jsxs("p",{className:"text-xs font-bold text-amber-800 uppercase",children:[e.severity," • ",e.source]}),l.jsx("p",{className:"text-sm text-amber-900 font-semibold",children:e.headline})]})]},e.id))]})})]})})}}});
