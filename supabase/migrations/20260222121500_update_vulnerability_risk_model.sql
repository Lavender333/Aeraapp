BEGIN;

CREATE OR REPLACE FUNCTION public.calculate_vulnerability_risk(
  p_household_size INTEGER,
  p_medication_dependency BOOLEAN,
  p_insulin_dependency BOOLEAN,
  p_oxygen_powered_device BOOLEAN,
  p_mobility_limitation BOOLEAN,
  p_transportation_access BOOLEAN,
  p_financial_strain BOOLEAN
)
RETURNS NUMERIC
LANGUAGE plpgsql
IMMUTABLE
SET search_path = public
AS $$
DECLARE
  score NUMERIC := 0;
  medical_count INTEGER := 0;
BEGIN
  score := score + LEAST(GREATEST(COALESCE(p_household_size, 1), 1), 6) * 0.4;

  IF COALESCE(p_medication_dependency, false) THEN
    score := score + 1.6;
    medical_count := medical_count + 1;
  END IF;
  IF COALESCE(p_insulin_dependency, false) THEN
    score := score + 2.4;
    medical_count := medical_count + 1;
  END IF;
  IF COALESCE(p_oxygen_powered_device, false) THEN
    score := score + 2.8;
    medical_count := medical_count + 1;
  END IF;
  IF COALESCE(p_mobility_limitation, false) THEN
    score := score + 1.7;
  END IF;
  IF NOT COALESCE(p_transportation_access, true) THEN
    score := score + 1.3;
  END IF;
  IF COALESCE(p_financial_strain, false) THEN
    score := score + 1.2;
  END IF;

  IF medical_count >= 2 THEN
    score := score + 0.8;
  END IF;
  IF COALESCE(p_mobility_limitation, false) AND NOT COALESCE(p_transportation_access, true) THEN
    score := score + 0.6;
  END IF;

  score := LEAST(score, 10);
  RETURN ROUND(score, 4);
END;
$$;

UPDATE public.vulnerability_profiles
SET risk_score = public.calculate_vulnerability_risk(
  household_size,
  medication_dependency,
  insulin_dependency,
  oxygen_powered_device,
  mobility_limitation,
  transportation_access,
  financial_strain
);

COMMIT;
